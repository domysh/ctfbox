<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTFBox Configuration Editor</title>
    <link rel="icon" href="./images/teams/ctfbox-player.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #212529;
            color: #e9ecef;
        }
        .container {
            max-width: 1200px;
            background-color: #2c3034;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        .header {
            margin-bottom: 30px;
            border-bottom: 1px solid #495057;
            padding-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #495057;
            border-radius: 5px;
            background-color: #343a40;
        }
        .section-title {
            margin-bottom: 20px;
            color: #6ea8fe;
        }
        .team-card {
            margin-bottom: 0;
            border: 1px solid #495057;
            border-radius: 5px;
            padding: 20px;
            background-color: #2c3034;
            position: relative;
            transition: all 0.2s ease;
        }
        .team-card:hover {
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .team-card.nop-team {
            border-left: 4px solid #0d6efd;
        }
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 1px solid #343a40;
        }
        .team-id-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #212529;
            color: #fff;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #495057;
            font-size: 1rem;
        }
        .team-container-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }
        @media (max-width: 768px) {
            .team-container-grid {
                grid-template-columns: 1fr;
            }
        }
        .team-switch-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .team-switch-container .form-check-input {
            width: 3em;
            height: 1.5em;
            margin-right: 10px;
        }
        .team-switch-container .form-check-label {
            font-weight: 500;
        }
        .advanced-toggle {
            cursor: pointer;
            color: #6ea8fe;
            user-select: none;
        }
        .advanced-settings {
            display: none;
            padding-top: 15px;
            border-top: 1px dashed #495057;
        }
        .btn-action {
            margin-top: 10px;
        }
        .form-floating {
            margin-bottom: 15px;
        }
        .input-group-text {
            background-color: #495057;
            color: #e9ecef;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #495057;
        }
        .json-preview {
            background-color: #212529;
            border: 1px solid #495057;
            border-radius: 5px;
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
        }
        pre {
            margin: 0;
            color: #e9ecef;
        }
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .preview-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .key {
            color: #6ea8fe;
        }
        .string {
            color: #79c0ff;
        }
        .number {
            color: #ffa657;
        }
        .boolean {
            color: #ff7b72;
        }
        .null {
            color: #f85149;
        }
        .time-note {
            font-size: 0.85rem;
            color: #adb5bd;
            margin-top: 5px;
        }
        .aligned-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        .form-check.form-switch {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: auto;
        }
        .form-check.form-switch .form-check-input {
            margin-right: 10px;
        }
        .form-check.form-switch .form-check-label {
            display: flex;
            align-items: center;
        }
        .col-md-6 .form-check.form-switch {
            justify-content: flex-start;
            margin: 0;
        }
        .preview-actions .form-check.form-switch {
            justify-content: flex-start;
            margin: 0;
        }
        
        /* Improved responsive styles */
        @media (max-width: 768px) {
            .section {
                padding: 15px;
                border: none;
                border-radius: 0;
                background-color: transparent;
                margin-bottom: 20px;
            }
            .team-card {
                border: none;
                border-radius: 0;
                padding: 15px 10px;
                margin-bottom: 15px;
                box-shadow: none;
            }
            .team-card.nop-team {
                border-left: 2px solid #0d6efd;
            }
            .json-preview {
                border: none;
                border-radius: 0;
                padding: 10px;
            }
            .header, .footer {
                border: none;
            }
            .team-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                border: none;
            }
            .preview-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .preview-actions {
                flex-wrap: wrap;
                margin-top: 10px;
                width: 100%;
            }
            .aligned-controls {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            .aligned-controls .form-floating {
                width: 100% !important; /* Override any inline styles */
            }
            button {
                margin-top: 5px;
            }
            
            /* Fix wrapping buttons to follow logical order */
            .btn-group, .preview-actions, .pins-container .row .col-md-2 {
                display: flex;
                flex-direction: column;
                width: 100%;
                align-items: stretch;
            }
            
            /* Make inputs full width on mobile */
            .form-control, .form-floating, .form-check {
                width: 100%;
            }
            
            /* Improve pin container layout */
            .pins-container .row {
                flex-direction: column;
            }
            .pins-container .row > div {
                width: 100%;
                margin-bottom: 10px;
            }
            .pins-container .row > div:last-child {
                margin-bottom: 0;
            }
            
            /* Make toasts full-width on mobile */
            .toast-container {
                right: 0;
                left: 0;
                bottom: 0;
                padding: 10px;
            }
            .container {
                padding: 15px;;
                border-radius: 0;
                background-color: transparent;
                box-shadow: none;
            }
            .toast {
                width: 100%;
            }
        }
        
        @media (max-width: 576px) {
            body {
                padding: 10px 0;
            }
            .section {
                padding: 10px 5px;
                margin-bottom: 15px;
            }
            .import-option {
                border: none;
                border-radius: 0;
                padding: 10px 5px;
            }
            .btn {
                border-radius: 3px;
            }
            .accordion-item {
                border: none;
            }
            .accordion-button {
                padding: 10px;
                border-radius: 0 !important;
            }
            
            /* Remove all inner borders in mobile view */
            .form-control, 
            .form-select, 
            .input-group-text,
            .modal-content,
            .toast {
                border-radius: 3px;
            }
            
            /* Reduce padding for better space usage */
            .modal-body, 
            .modal-header, 
            .modal-footer,
            .accordion-body {
                padding: 10px;
            }
        }

        /* Make modal animations faster */
        .modal.fade .modal-dialog {
            transition: transform 0.15s ease-out !important;
        }

        /* Toast styles */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1060;
        }

        .toast {
            background-color: #343a40;
            border-left: 4px solid #6ea8fe;
        }

        .toast.bg-success {
            border-left-color: #198754;
        }

        .toast-header {
            background-color: rgba(52, 58, 64, 0.9);
            color: #e9ecef;
        }
        
        /* Import dialog styles */
        .import-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .import-option {
            padding: 20px;
            border: 1px solid #495057;
            border-radius: 5px;
            background-color: #343a40;
        }
        
        .import-option-title {
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        #importConfigTextarea {
            min-height: 150px;
            font-family: monospace;
            background-color: #212529;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-center">CTFBox Configuration Editor</h1>
            <p class="text-center text-muted">Generate configuration file for CTFBox</p>
        </div>
        
        <div class="section">
            <h3 class="section-title">Basic Settings</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="wireguardStartPort" value="51000" min="1">
                        <label for="wireguardStartPort">Wireguard Start Port</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="wireguardProfiles" value="30" min="1">
                        <label for="wireguardProfiles">Wireguard Profiles</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="serverAddr" required>
                        <label for="serverAddr">Server Address (Required)</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="dns" value="1.1.1.1">
                        <label for="dns">DNS Server</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Time Settings</h3>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="datetime-local" class="form-control" id="startTime">
                        <label for="startTime">Start Time (Optional)</label>
                    </div>
                    <div class="time-note">Uses your current time zone</div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="datetime-local" class="form-control" id="endTime">
                        <label for="endTime">End Time (Optional)</label>
                    </div>
                    <div class="time-note">Uses your current time zone</div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="tickTime" value="120" min="1">
                        <label for="tickTime">Tick Time (seconds)</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Game Settings</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="flagExpireTicks" value="5" min="1">
                        <label for="flagExpireTicks">Flag Expire Ticks</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="initialServiceScore" value="5000" min="0">
                        <label for="initialServiceScore">Initial Service Score</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="maxFlagsPerRequest" value="3000" min="1">
                        <label for="maxFlagsPerRequest">Max Flags Per Request</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="submissionTimeout" value="0.03" min="0" step="0.01">
                        <label for="submissionTimeout">Submission Timeout</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Resource Settings</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="networkLimitBandwidth" value="20mbit">
                        <label for="networkLimitBandwidth">Network Limit Bandwidth</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="maxVmCpus" value="1">
                        <label for="maxVmCpus">Max VM CPUs</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="maxVmMem" value="2G">
                        <label for="maxVmMem">Max VM Memory</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-switch mt-4">
                        <input class="form-check-input" type="checkbox" id="enableDiskLimit">
                        <label class="form-check-label" for="enableDiskLimit">Enable Disk Limit</label>
                    </div>
                    <div id="diskLimitField" style="display: none;">
                        <div class="form-floating mt-3">
                            <input type="text" class="form-control" id="maxDiskSize" value="30G">
                            <label for="maxDiskSize">Max Disk Size</label>
                        </div>
                        <small class="text-muted mt-1 d-block">
                            Note: Requires XFS filesystem with pquota enabled on the host
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Server Settings</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="gameserverToken" placeholder="Auto-generated if empty">
                        <label for="gameserverToken">Gameserver Token (Optional)</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="unsafePrivileged">
                        <label class="form-check-label" for="unsafePrivileged">Use Privileged Mode (Not Recommended)</label>
                    </div>
                    <small class="d-block text-muted mt-1">
                        When enabled, sysbox will not be used and doesn't need to be installed
                    </small>
                    <div class="form-check form-switch mt-3">
                        <input class="form-check-input" type="checkbox" id="exposeGameserver">
                        <label class="form-check-label" for="exposeGameserver">Expose Gameserver</label>
                    </div>
                    <div id="gameserverPortField" style="display: none;">
                        <div class="form-floating mt-3">
                            <input type="text" class="form-control" id="gameserverExposedPort" value="127.0.0.1:8888">
                            <label for="gameserverExposedPort">Gameserver Port</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-check form-switch mt-3">
                <input class="form-check-input" type="checkbox" id="debugMode">
                <label class="form-check-label" for="debugMode">Debug Mode</label>
            </div>
            <div class="form-check form-switch mt-3" style="display: none;">
                <input class="form-check-input" type="checkbox" id="pinDataAdded" checked>
                <label class="form-check-label" for="pinDataAdded">Enable Pin Editing</label>
                <small class="d-block text-muted mt-1">
                    When enabled, you can create and edit pins in this editor. When disabled, pin editing is locked because pins will be managed by the credential server.
                </small>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Team Configuration</h3>
            <div class="row align-items-center mb-3 justify-content-center">
                <div class="col-md-4 col-lg-3">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="numberOfTeams" value="4" min="1" max="249">
                        <label for="numberOfTeams">Number of Teams</label>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3 mt-3 mt-md-0">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enableNopTeam">
                        <label class="form-check-label" for="enableNopTeam">Enable NOP Team</label>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3 mt-3 mt-md-0">
                    <button class="btn btn-primary w-100" id="generateTeams">Generate Teams</button>
                </div>
            </div>
            
            <div class="team-actions d-flex flex-wrap justify-content-between align-items-center mb-3">
                <div>
                    <button class="btn btn-outline-success" id="addSingleTeam">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg> Add Team
                    </button>
                </div>
                <span class="text-muted small"><span id="teamCountDisplay">0</span> teams configured</span>
            </div>
            
            <div id="teamsContainer" class="team-container-grid">
                <!-- Teams will be generated here -->
            </div>
        </div>
        
        <div class="section">
            <div class="preview-header">
                <h3 class="section-title">Configuration Preview</h3>
                <div class="preview-actions">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">Auto-Refresh</label>
                    </div>
                    <button class="btn btn-outline-info" id="copyConfig">Copy to Clipboard</button>
                    <button class="btn btn-outline-success" id="copyCompressedConfig">Copy Compressed Config</button>
                </div>
            </div>
            <div class="json-preview">
                <pre id="configPreview">// Configuration will be shown here when you modify settings</pre>
            </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
            <div class="d-grid gap-2 d-md-flex">
                <button class="btn btn-primary btn-lg flex-grow-1" id="generateConfig">Generate Configuration</button>
                <button class="btn btn-outline-info btn-lg" id="importConfig">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg> Import
                </button>
            </div>
            <button class="btn btn-success btn-lg" id="downloadConfig" aria-label="Download Configuration">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
            </button>
        </div>
        
        <div class="footer">
            <p>CTFBox Configuration Editor</p>
        </div>
    </div>
    
    <!-- Toast container -->
    <div class="toast-container">
        <!-- Toasts will be created dynamically -->
    </div>

    <!-- Modal for error messages -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="errorModalBody">
                    An error occurred.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for importing configuration -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">Import Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="import-options">
                        <div class="import-option">
                            <div class="import-option-title">Option 1: Upload JSON File</div>
                            <div class="mb-3">
                                <input class="form-control" type="file" id="importConfigFile" accept="application/json">
                            </div>
                        </div>
                        
                        <div class="import-option">
                            <div class="import-option-title">Option 2: Paste JSON or Compressed Base64</div>
                            <div class="mb-3">
                                <textarea class="form-control" id="importConfigTextarea" placeholder="Paste your configuration JSON or compressed Base64 string here"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle me-2" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                        You can import a regular JSON configuration file or a compressed Base64 string. This will overwrite your current settings.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="processImport">Import Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add a debounce function to limit how often preview updates
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        let updatePreviewDebounced = debounce(function() {
            if (document.getElementById('autoRefresh').checked) {
                updatePreview();
            }
        }, 300);

        // Toast handling function
        function showToast(message, type = 'success') {
            // Create toast element
            const toastId = `toast-${Date.now()}`;
            const toastElement = document.createElement('div');
            toastElement.className = `toast align-items-center border-0 ${type === 'success' ? 'bg-success' : ''}`;
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            toastElement.id = toastId;
            
            // Toast content
            toastElement.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // Add to container
            document.querySelector('.toast-container').appendChild(toastElement);
            
            // Initialize and show toast
            const toast = new bootstrap.Toast(toastElement, {
                animation: true,
                autohide: true,
                delay: 3000
            });
            toast.show();
            
            // Remove from DOM after hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
        
        // Modal handling functions
        function showSuccessModal(message) {
            showToast(message, 'success');
        }
        
        function showErrorModal(message) {
            const modalBody = document.getElementById('errorModalBody');
            modalBody.textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Handle disk limit toggle
            document.getElementById('enableDiskLimit').addEventListener('change', function() {
                document.getElementById('diskLimitField').style.display = this.checked ? 'block' : 'none';
                updatePreviewDebounced();
            });
            
            // Handle gameserver expose toggle
            document.getElementById('exposeGameserver').addEventListener('change', function() {
                document.getElementById('gameserverPortField').style.display = this.checked ? 'block' : 'none';
                updatePreviewDebounced();
            });
            
            // Generate team fields
            document.getElementById('generateTeams').addEventListener('click', function() {
                generateTeamFields();
                updatePreviewDebounced();
            });
            
            // Add single team
            document.getElementById('addSingleTeam').addEventListener('click', function() {
                addSingleTeam();
                updatePreviewDebounced();
            });
            
            // Generate configuration
            document.getElementById('generateConfig').addEventListener('click', function() {
                try {
                    const config = buildConfigObject();
                    const jsonStr = JSON.stringify(config, null, 4);
                    const coloredJson = syntaxHighlight(jsonStr);
                    document.getElementById('configPreview').innerHTML = coloredJson;
                    showToast('Configuration generated successfully!');
                } catch (error) {
                    showErrorModal(`Error: ${error.message}`);
                }
            });
            
            // Download configuration
            document.getElementById('downloadConfig').addEventListener('click', function() {
                try {
                    // Check if there is a valid configuration already
                    let config;
                    try {
                        config = buildConfigObject();
                    } catch (error) {
                        showErrorModal(`Cannot download: ${error.message}`);
                        return;
                    }
                    
                    // Generate and download the JSON
                    downloadJSON(config, 'config.json');
                    showToast('Configuration downloaded successfully!');
                } catch (error) {
                    showErrorModal(`Error: ${error.message}`);
                }
            });
            
            // Copy config
            document.getElementById('copyConfig').addEventListener('click', copyConfigToClipboard);
            
            // Copy compressed config
            document.getElementById('copyCompressedConfig').addEventListener('click', copyCompressedConfigToClipboard);
            
            // Import configuration
            document.getElementById('importConfig').addEventListener('click', function() {
                const importModal = new bootstrap.Modal(document.getElementById('importModal'));
                importModal.show();
            });
            
            // Process import button click
            document.getElementById('processImport').addEventListener('click', processImportConfig);
            
            // Auto-refresh toggle - fix by adding direct update
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    updatePreview(); // Directly update when toggled on
                }
            });
            
            // Initialize with default teams
            generateTeamFields();
            
            // Add mutation observer to detect when new form elements are added
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.querySelectorAll) {
                                setupFormListeners(node);
                            }
                        });
                    }
                });
            });
            
            // Start observing the container for dynamic content
            observer.observe(document.getElementById('teamsContainer'), {
                childList: true,
                subtree: true
            });
            
            // Initial setup for existing form elements
            setupFormListeners(document);
            
            // Ensure the initial state is set correctly
            if (document.getElementById('autoRefresh').checked) {
                updatePreview();
            }

            // Handle pin editing toggle
            document.getElementById('pinDataAdded').addEventListener('change', function() {
                const isEnabled = this.checked;
                document.querySelectorAll('.pins-container input, .pins-container button').forEach(element => {
                    element.disabled = !isEnabled;
                });
                updatePreviewDebounced();
            });
        });
        
        function setupFormListeners(rootElement) {
            // Improved event listener setup
            rootElement.querySelectorAll('input, select, textarea').forEach(element => {
                // Remove existing listeners to prevent duplicates
                element.removeEventListener('change', updatePreviewDebounced);
                element.removeEventListener('input', updatePreviewDebounced);
                
                // Add new listeners
                element.addEventListener('change', updatePreviewDebounced);
                if (element.type === 'text' || element.type === 'number' || 
                    element.type === 'datetime-local' || element.type === 'textarea') {
                    element.addEventListener('input', updatePreviewDebounced);
                }
                
                // For checkboxes and radio buttons
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.addEventListener('change', function() {
                        setTimeout(updatePreviewDebounced, 0); // Use setTimeout to ensure it runs after state change
                    });
                }
            });
        }

        function generateTeamFields() {
            const numberOfTeams = parseInt(document.getElementById('numberOfTeams').value);
            const enableNopTeam = document.getElementById('enableNopTeam').checked;
            const teamsContainer = document.getElementById('teamsContainer');
            
            // Store existing team data
            const existingTeams = {};
            document.querySelectorAll('.team-card').forEach(teamCard => {
                const teamId = parseInt(teamCard.getAttribute('data-team-id'));
                
                // Skip if team id is NaN
                if (isNaN(teamId)) return;
                
                // Collect all data for this team
                const teamData = {
                    name: document.getElementById(`teamName-${teamId}`)?.value || `Team ${teamId}`,
                    token: document.getElementById(`teamToken-${teamId}`)?.value || "",
                    nop: document.getElementById(`teamNop-${teamId}`)?.checked || false,
                    wireguardPort: document.getElementById(`teamWireguardPort-${teamId}`)?.value || (51000 + teamId),
                    image: document.getElementById(`teamImage-${teamId}`)?.value || "",
                    pins: []
                };
                
                // Collect pins
                const pinsContainer = document.getElementById(`pins-container-${teamId}`);
                if (pinsContainer) {
                    const pinRows = pinsContainer.children;
                    for (let j = 0; j < pinRows.length; j++) {
                        const pinElement = document.getElementById(`teamPin-${teamId}-${j}`);
                        const profileElement = document.getElementById(`teamPinProfile-${teamId}-${j}`);
                        
                        if (pinElement && profileElement && pinElement.value) {
                            teamData.pins.push({
                                pin: pinElement.value,
                                profile: parseInt(profileElement.value)
                            });
                        }
                    }
                }
                
                existingTeams[teamId] = teamData;
            });
            
            // Clear the container but keep old team data
            teamsContainer.innerHTML = '';
            
            let startIndex = enableNopTeam ? 0 : 1;
            let endIndex = enableNopTeam ? numberOfTeams + 1 : numberOfTeams + 1;
            
            // If NOP team is enabled, make sure we create or keep it
            if (enableNopTeam) {
                // Check if NOP team already exists
                if (existingTeams[0]) {
                    // Use existing NOP team data
                    const nopTeamData = existingTeams[0];
                    nopTeamData.nop = true; // Ensure it's marked as NOP
                    const nopTeam = createTeamCard(0, nopTeamData.name, true);
                    nopTeam.setAttribute('data-team-id', '0');
                    teamsContainer.appendChild(nopTeam);
                    
                    // Restore values
                    document.getElementById(`teamToken-0`).value = nopTeamData.token;
                    document.getElementById(`teamWireguardPort-0`).value = nopTeamData.wireguardPort;
                    document.getElementById(`teamImage-0`).value = nopTeamData.image;
                    updateTeamImagePreview(nopTeamData.image, 0);
                    
                    // Restore pins
                    if (nopTeamData.pins.length > 0) {
                        const pinsContainer = document.getElementById(`pins-container-0`);
                        nopTeamData.pins.forEach((pin, idx) => {
                            addPin(0, pin.pin, pin.profile);
                        });
                    }
                } else {
                    // Create new NOP team
                    const nopTeam = createTeamCard(0, 'Nop Team', true);
                    nopTeam.setAttribute('data-team-id', '0');
                    teamsContainer.appendChild(nopTeam);
                }
            }
            
            // Create teams from 1 to number of teams
            for (let i = 1; i <= numberOfTeams; i++) {
                // Use existing data if available
                if (existingTeams[i]) {
                    const teamData = existingTeams[i];
                    const team = createTeamCard(i, teamData.name, teamData.nop);
                    team.setAttribute('data-team-id', i.toString());
                    teamsContainer.appendChild(team);
                    
                    // Restore values
                    document.getElementById(`teamNop-${i}`).checked = teamData.nop;
                    document.getElementById(`teamToken-${i}`).value = teamData.token;
                    document.getElementById(`teamWireguardPort-${i}`).value = teamData.wireguardPort;
                    document.getElementById(`teamImage-${i}`).value = teamData.image;
                    updateTeamImagePreview(teamData.image, i);
                    
                    // Restore pins
                    if (teamData.pins.length > 0) {
                        const pinsContainer = document.getElementById(`pins-container-${i}`);
                        teamData.pins.forEach((pin) => {
                            addPin(i, pin.pin, pin.profile);
                        });
                    }
                } else {
                    // Create new team
                    const team = createTeamCard(i, `Team ${i}`, false);
                    team.setAttribute('data-team-id', i.toString());
                    teamsContainer.appendChild(team);
                }
            }
            
            updatePreviewDebounced();
            updateTeamCount();
        }
        
        function addSingleTeam() {
            const teamsContainer = document.getElementById('teamsContainer');
            
            // Find the highest team ID currently in use
            let highestId = 0;
            document.querySelectorAll('.team-card').forEach(teamCard => {
                const teamId = parseInt(teamCard.getAttribute('data-team-id'));
                if (!isNaN(teamId) && teamId > highestId) {
                    highestId = teamId;
                }
            });
            
            // Create a new team with the next available ID
            const newTeamId = highestId + 1;
            const team = createTeamCard(newTeamId, `Team ${newTeamId}`, false);
            team.setAttribute('data-team-id', newTeamId.toString());
            teamsContainer.appendChild(team);
            
            // Set up form listeners for the new team
            setupFormListeners(team);

            updatePreviewDebounced();
            updateTeamCount();
        }
        
        function removeTeam(teamId) {
            const teamCard = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (teamCard) {
                // Check if it's a NOP team (team 0) and warn if enable NOP team is checked
                if (teamId === 0 && document.getElementById('enableNopTeam').checked) {
                    if (!confirm("This will remove the NOP team, but it may be re-added if 'Enable NOP Team' is still checked. Continue?")) {
                        return;
                    }
                }
                
                teamCard.remove();
                updatePreviewDebounced();
            }

            updateTeamCount();
        }
        
        function createTeamCard(id, name, isNop) {
            const card = document.createElement('div');
            card.className = `team-card ${isNop ? 'nop-team' : ''}`;
            card.setAttribute('data-team-id', id.toString());
            
            // Create ID badge
            const idBadge = document.createElement('div');
            idBadge.className = 'team-id-badge';
            idBadge.textContent = id;
            card.appendChild(idBadge);
            
            // Create team header
            const header = document.createElement('div');
            header.className = 'team-header';
            
            // Populate header with title and delete button
            header.innerHTML = `
                <div class="d-flex align-items-center gap-2">
                    <h5 class="team-title m-0" id="team-title-${id}">${name}</h5>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTeam(${id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
                        </svg> Remove
                    </button>
                </div>
            `;
            
            // Create team content
            const content = document.createElement('div');
            content.innerHTML = `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="teamName-${id}" value="${name}" oninput="updateTeamTitle(${id}, this.value)">
                            <label for="teamName-${id}">Team Name</label>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="teamNop-${id}" ${isNop ? 'checked' : ''} ${id === 0 ? 'disabled' : ''} onchange="updateTeamNopStatus(${id}, this.checked)">
                            <label class="form-check-label" for="teamNop-${id}">NOP Team</label>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="teamToken-${id}" placeholder="Auto-generated if empty">
                            <label for="teamToken-${id}">Team Token (Optional)</label>
                        </div>
                    </div>
                </div>
                
                <div class="team-image-container mb-4">
                    <label class="form-label fw-bold">Team Image</label>
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3" style="width: 80px; height: 80px; overflow: hidden; border-radius: 5px; background-color: #212529;">
                            <img id="teamImagePreview-${id}" 
                                 src="./images/teams/ctfbox-player.png" 
                                 onerror="this.src='./images/teams/ctfbox-player.png'" 
                                 alt="Team Logo" 
                                 style="width: 100%; height: 100%; object-fit: contain;">
                        </div>
                        <div class="d-flex flex-column">
                            <div class="d-flex mb-2">
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="selectImageFile(${id})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                                    </svg> Upload
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTeamImage(${id})">Remove</button>
                            </div>
                            <small class="text-muted">Max 1MB, JPG/PNG (via ImgBB)</small>
                        </div>
                    </div>
                    <input type="file" id="teamImageFile-${id}" accept="image/jpeg, image/png" style="display: none;" onchange="uploadTeamImage(this, ${id})">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="teamImage-${id}" value="" oninput="updateTeamImagePreview(this.value, ${id})">
                        <label for="teamImage-${id}">Image URL</label>
                    </div>
                    <div id="uploadProgress-${id}" class="progress mt-2" style="display: none; height: 5px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="accordion mb-3" id="accordionTeamAdvanced-${id}">
                    <div class="accordion-item bg-dark">
                        <h2 class="accordion-header" id="headingAdvanced-${id}">
                            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapseAdvanced-${id}" aria-expanded="false" aria-controls="collapseAdvanced-${id}">
                                Advanced Settings
                            </button>
                        </h2>
                        <div id="collapseAdvanced-${id}" class="accordion-collapse collapse" aria-labelledby="headingAdvanced-${id}">
                            <div class="accordion-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="number" class="form-control" id="teamWireguardPort-${id}" value="${51000 + parseInt(id)}">
                                            <label for="teamWireguardPort-${id}">Wireguard Port</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="pins-section">
                                    <h6>Team Pins</h6>
                                    <div class="pins-container" id="pins-container-${id}">
                                        <!-- Pins will be added here -->
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addPin(${id})">Add Pin</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Append everything to the card
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        function addPin(teamId, pinValue = '', profileValue = 0) {
            const pinsContainer = document.getElementById(`pins-container-${teamId}`);
            const pinIndex = pinsContainer.children.length;
            
            const pinRow = document.createElement('div');
            pinRow.className = 'row mb-3';
            pinRow.innerHTML = `
                <div class="col-md-5">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="teamPin-${teamId}-${pinIndex}" value="${pinValue}">
                        <label for="teamPin-${teamId}-${pinIndex}">Pin</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="teamPinProfile-${teamId}-${pinIndex}" value="${profileValue}">
                        <label for="teamPinProfile-${teamId}-${pinIndex}">Profile</label>
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-center">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePin(this)">Remove</button>
                </div>
            `;
            pinsContainer.appendChild(pinRow);
            updatePreviewDebounced();
            
            return pinRow;
        }
        
        // Team image handling functions
        function selectImageFile(teamId) {
            document.getElementById(`teamImageFile-${teamId}`).click();
        }
        
        function uploadTeamImage(fileInput, teamId) {
            if (!fileInput.files || !fileInput.files[0]) return;
            
            const file = fileInput.files[0];
            
            // File size validation (1MB max)
            if (file.size > 1024 * 1024) {
                showErrorModal("Image file is too large. Maximum size is 1MB.");
                return;
            }
            
            // Show progress bar
            const progressBar = document.querySelector(`#uploadProgress-${teamId} .progress-bar`);
            document.getElementById(`uploadProgress-${teamId}`).style.display = 'flex';
            progressBar.style.width = '0%';
            
            // Use FormData to prepare the upload
            const formData = new FormData();
            formData.append('image', file);
            
            // Create a unique temporary preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(`teamImagePreview-${teamId}`).src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Upload to ImgBB API
            fetch('https://api.imgbb.com/1/upload?key=fd9dbdfc2bd2f6899698c47d0b8e1ea9', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update the image URL input with the direct URL
                    const imageUrl = data.data.url;
                    document.getElementById(`teamImage-${teamId}`).value = imageUrl;
                    document.getElementById(`teamImagePreview-${teamId}`).src = imageUrl;
                    showToast('Image uploaded successfully to ImgBB!');
                    updatePreviewDebounced();
                } else {
                    throw new Error('Upload to ImgBB failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showErrorModal(`Failed to upload image to ImgBB: ${error.message}`);
                // Reset preview to previous value or default
                updateTeamImagePreview(document.getElementById(`teamImage-${teamId}`).value, teamId);
            })
            .finally(() => {
                // Hide progress bar
                document.getElementById(`uploadProgress-${teamId}`).style.display = 'none';
            });
        }
        
        function removeTeamImage(teamId) {
            document.getElementById(`teamImage-${teamId}`).value = '';
            document.getElementById(`teamImagePreview-${teamId}`).src = './images/teams/ctfbox-player.png';
            document.getElementById(`teamImageFile-${teamId}`).value = '';
            updatePreviewDebounced();
        }
        
        function updateTeamImagePreview(imageUrl, teamId) {
            const preview = document.getElementById(`teamImagePreview-${teamId}`);
            preview.src = imageUrl || './images/teams/ctfbox-player.png';
            updatePreviewDebounced();
        }
        
        function updateTeamTitle(id, newName) {
            const titleElement = document.getElementById(`team-title-${id}`);
            if (titleElement) {
                titleElement.textContent = newName;
            }
            updatePreviewDebounced();
        }
        
        function updateTeamNopStatus(id, isNop) {
            const teamCard = document.querySelector(`.team-card[data-team-id="${id}"]`);
            if (teamCard) {
                if (isNop) {
                    teamCard.classList.add('nop-team');
                } else {
                    teamCard.classList.remove('nop-team');
                }
            }
            updatePreviewDebounced();
        }
        
        function updateTeamCount() {
            const teamCount = document.querySelectorAll('.team-card').length;
            document.getElementById('teamCountDisplay').textContent = teamCount;
            updatePreviewDebounced();
        }
        
        function updatePreview() {
            try {
                const config = buildConfigObject();
                const jsonStr = JSON.stringify(config, null, 4);
                const coloredJson = syntaxHighlight(jsonStr);
                document.getElementById('configPreview').innerHTML = coloredJson;
            } catch (error) {
                document.getElementById('configPreview').innerHTML = `Error generating preview: ${error.message}`;
            }
        }
        
        function copyConfigToClipboard() {
            try {
                const config = buildConfigObject();
                const jsonStr = JSON.stringify(config, null, 4);
                navigator.clipboard.writeText(jsonStr).then(() => {
                    const copyBtn = document.getElementById('copyConfig');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                    }, 2000);
                    showToast('Configuration copied to clipboard!');
                });
            } catch (error) {
                showErrorModal(`Failed to copy: ${error.message}`);
            }
        }
        
        function copyCompressedConfigToClipboard() {
            try {
                const config = buildConfigObject();
                const jsonStr = JSON.stringify(config);
                
                // Use pako.js for compression if available, otherwise alert that we need to include it
                if (typeof pako !== 'undefined') {
                    const compressed = pako.deflate(jsonStr);
                    const base64 = btoa(String.fromCharCode.apply(null, compressed));
                    navigator.clipboard.writeText(base64).then(() => {
                        const copyBtn = document.getElementById('copyCompressedConfig');
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                        }, 2000);
                        showToast('Compressed configuration copied to clipboard!');
                    });
                } else {
                    // Fallback to simple base64 without compression
                    const base64 = btoa(jsonStr);
                    navigator.clipboard.writeText(base64).then(() => {
                        const copyBtn = document.getElementById('copyCompressedConfig');
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied! (Uncompressed)';
                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                        }, 2000);
                        showToast('Configuration copied in base64 format (uncompressed)');
                    });
                }
            } catch (error) {
                showErrorModal(`Failed to copy compressed config: ${error.message}`);
            }
        }
        
        function buildConfigObject() {
            // Validate required fields
            const serverAddr = document.getElementById('serverAddr').value.trim();
            if (!serverAddr) {
                throw new Error('Server Address is required');
            }
            
            // Basic settings
            const config = {
                wireguard_start_port: parseInt(document.getElementById('wireguardStartPort').value),
                wireguard_profiles: parseInt(document.getElementById('wireguardProfiles').value),
                server_addr: serverAddr,
                dns: document.getElementById('dns').value,
                tick_time: parseInt(document.getElementById('tickTime').value),
                flag_expire_ticks: parseInt(document.getElementById('flagExpireTicks').value),
                initial_service_score: parseInt(document.getElementById('initialServiceScore').value),
                max_flags_per_request: parseInt(document.getElementById('maxFlagsPerRequest').value),
                submission_timeout: parseFloat(document.getElementById('submissionTimeout').value),
                network_limit_bandwidth: document.getElementById('networkLimitBandwidth').value,
                max_vm_cpus: document.getElementById('maxVmCpus').value,
                max_vm_mem: document.getElementById('maxVmMem').value,
                gameserver_token: document.getElementById('gameserverToken').value || generateRandomToken(),
                unsafe_privileged: document.getElementById('unsafePrivileged').checked,
                debug: document.getElementById('debugMode').checked,
                pin_data_added: document.getElementById('pinDataAdded').checked
            };
            
            // Time settings
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (startTime) {
                // Convert to ISO string but note it's in local timezone
                const startDate = new Date(startTime);
                config.start_time = startDate.toISOString();
            }
            
            if (endTime) {
                // Convert to ISO string but note it's in local timezone
                const endDate = new Date(endTime);
                config.end_time = endDate.toISOString();
            }
            
            // Resource settings
            if (document.getElementById('enableDiskLimit').checked) {
                config.max_disk_size = document.getElementById('maxDiskSize').value;
            }
            
            // Gameserver settings
            if (document.getElementById('exposeGameserver').checked) {
                config.gameserver_exposed_port = document.getElementById('gameserverExposedPort').value;
            }
            
            // Team configuration
            config.teams = [];
            const numberOfTeams = parseInt(document.getElementById('numberOfTeams').value);
            const enableNopTeam = document.getElementById('enableNopTeam').checked;
            
            let startIndex = 0;
            let totalTeams = numberOfTeams;
            
            if (enableNopTeam) {
                startIndex = 1;
                totalTeams += 1;
            }
            
            for (let i = 0; i < totalTeams; i++) {
                if (i === 0 && !enableNopTeam) {
                    continue;
                }
                
                const teamNameElement = document.getElementById(`teamName-${i}`);
                if (!teamNameElement) continue;
                
                const team = {
                    id: i,
                    name: teamNameElement.value,
                    token: document.getElementById(`teamToken-${i}`).value || generateRandomToken(),
                    wireguard_port: parseInt(document.getElementById(`teamWireguardPort-${i}`).value),
                    nop: document.getElementById(`teamNop-${i}`).checked,
                    image: document.getElementById(`teamImage-${i}`).value || "",
                    pins: []
                };
                
                // Add pins if they exist
                const pinsContainer = document.getElementById(`pins-container-${i}`);
                if (pinsContainer) {
                    const pinRows = pinsContainer.children;
                    for (let j = 0; j < pinRows.length; j++) {
                        const pinElement = document.getElementById(`teamPin-${i}-${j}`);
                        const profileElement = document.getElementById(`teamPinProfile-${i}-${j}`);
                        
                        if (pinElement && profileElement && pinElement.value) {
                            team.pins.push({
                                pin: pinElement.value,
                                profile: parseInt(profileElement.value)
                            });
                        }
                    }
                }
                
                config.teams.push(team);
            }
            
            return config;
        }
        
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                        match = match.replace(/"/g, '').replace(/:$/, '');
                        return `"<span class="${cls}">${match}</span>": `;
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return `<span class="${cls}">${match}</span>`;
            });
        }
        
        function generateRandomToken() {
            const array = new Uint8Array(32);
            window.crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }
        
        function downloadJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 4);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Ensure removePin function exists and updates preview
        function removePin(button) {
            const pinRow = button.closest('.row');
            pinRow.remove();
            updatePreviewDebounced();
        }

        // Function to process the imported configuration
        function processImportConfig() {
            // Check file input first
            const fileInput = document.getElementById('importConfigFile');
            const textInput = document.getElementById('importConfigTextarea').value.trim();
            
            if (fileInput.files && fileInput.files[0]) {
                // Handle file import
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const config = JSON.parse(content);
                        applyImportedConfig(config);
                        
                        // Close modal
                        const importModal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                        importModal.hide();
                    } catch (error) {
                        showErrorModal(`Error parsing JSON file: ${error.message}`);
                    }
                };
                reader.readAsText(fileInput.files[0]);
            } else if (textInput) {
                // Handle pasted text
                try {
                    let config;
                    
                    // Try to parse as JSON
                    try {
                        config = JSON.parse(textInput);
                    } catch (jsonError) {
                        // Not valid JSON, try as compressed base64
                        try {
                            // Check if pako is available for decompression
                            if (typeof pako === 'undefined') {
                                throw new Error("Compression library not loaded. Cannot decompress base64 input.");
                            }
                            
                            // Decode base64 and decompress
                            const binaryString = atob(textInput);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            
                            // Try to decompress
                            const decompressed = pako.inflate(bytes, { to: 'string' });
                            config = JSON.parse(decompressed);
                        } catch (decompressError) {
                            throw new Error("Input is neither valid JSON nor compressed base64: " + decompressError.message);
                        }
                    }
                    
                    // Apply the config
                    applyImportedConfig(config);
                    
                    // Close modal
                    const importModal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                    importModal.hide();
                } catch (error) {
                    showErrorModal(`Error processing input: ${error.message}`);
                }
            } else {
                showErrorModal("Please upload a file or paste configuration text.");
            }
        }
        
        // Function to apply imported configuration to UI
        function applyImportedConfig(config) {
            try {
                // Reset form to defaults first
                resetFormToDefaults();
                
                // Apply basic settings
                if (config.wireguard_start_port) document.getElementById('wireguardStartPort').value = config.wireguard_start_port;
                if (config.wireguard_profiles) document.getElementById('wireguardProfiles').value = config.wireguard_profiles;
                if (config.server_addr) document.getElementById('serverAddr').value = config.server_addr;
                if (config.dns) document.getElementById('dns').value = config.dns;
                
                // Time settings
                if (config.tick_time) document.getElementById('tickTime').value = config.tick_time;
                
                if (config.start_time) {
                    const startDate = new Date(config.start_time);
                    document.getElementById('startTime').value = formatDateForInput(startDate);
                }
                
                if (config.end_time) {
                    const endDate = new Date(config.end_time);
                    document.getElementById('endTime').value = formatDateForInput(endDate);
                }
                
                // Game settings
                if (config.flag_expire_ticks) document.getElementById('flagExpireTicks').value = config.flag_expire_ticks;
                if (config.initial_service_score) document.getElementById('initialServiceScore').value = config.initial_service_score;
                if (config.max_flags_per_request) document.getElementById('maxFlagsPerRequest').value = config.max_flags_per_request;
                if (config.submission_timeout) document.getElementById('submissionTimeout').value = config.submission_timeout;
                
                // Resource settings
                if (config.network_limit_bandwidth) document.getElementById('networkLimitBandwidth').value = config.network_limit_bandwidth;
                if (config.max_vm_cpus) document.getElementById('maxVmCpus').value = config.max_vm_cpus;
                if (config.max_vm_mem) document.getElementById('maxVmMem').value = config.max_vm_mem;
                
                // Disk limit
                if (config.max_disk_size) {
                    document.getElementById('enableDiskLimit').checked = true;
                    document.getElementById('diskLimitField').style.display = 'block';
                    document.getElementById('maxDiskSize').value = config.max_disk_size;
                }
                
                // Server settings
                if (config.gameserver_token) document.getElementById('gameserverToken').value = config.gameserver_token;
                if (config.unsafe_privileged !== undefined) document.getElementById('unsafePrivileged').checked = config.unsafe_privileged;
                if (config.debug !== undefined) document.getElementById('debugMode').checked = config.debug;
                if (config.pin_data_added !== undefined) document.getElementById('pinDataAdded').checked = config.pin_data_added;
                
                // Gameserver exposed port
                if (config.gameserver_exposed_port) {
                    document.getElementById('exposeGameserver').checked = true;
                    document.getElementById('gameserverPortField').style.display = 'block';
                    document.getElementById('gameserverExposedPort').value = config.gameserver_exposed_port;
                }
                
                // Handle teams
                if (config.teams && Array.isArray(config.teams) && config.teams.length > 0) {
                    // Clear existing teams
                    document.getElementById('teamsContainer').innerHTML = '';
                    
                    // Check for NOP team
                    const hasNopTeam = config.teams.some(team => team.id === 0 || team.nop === true);
                    document.getElementById('enableNopTeam').checked = hasNopTeam;
                    
                    // Update number of teams
                    const regularTeams = config.teams.filter(team => team.id > 0 || !team.nop);
                    document.getElementById('numberOfTeams').value = regularTeams.length;
                    
                    // Create team cards for each team
                    config.teams.forEach(team => {
                        const teamCard = createTeamCard(team.id, team.name, team.nop);
                        teamCard.setAttribute('data-team-id', team.id);
                        document.getElementById('teamsContainer').appendChild(teamCard);
                        
                        // Set team values
                        document.getElementById(`teamName-${team.id}`).value = team.name;
                        if (team.nop !== undefined && team.id !== 0) document.getElementById(`teamNop-${team.id}`).checked = team.nop;
                        if (team.token) document.getElementById(`teamToken-${team.id}`).value = team.token;
                        if (team.wireguard_port) document.getElementById(`teamWireguardPort-${team.id}`).value = team.wireguard_port;
                        if (team.image) {
                            document.getElementById(`teamImage-${team.id}`).value = team.image;
                            updateTeamImagePreview(team.image, team.id);
                        }
                        
                        // Add pins if present
                        if (team.pins && Array.isArray(team.pins) && team.pins.length > 0) {
                            team.pins.forEach(pin => {
                                addPin(team.id, pin.pin, pin.profile);
                            });
                        }
                        
                        // Update team card UI
                        updateTeamTitle(team.id, team.name);
                        updateTeamNopStatus(team.id, team.nop);
                    });
                }
                
                // Update counts and preview
                updateTeamCount();
                updatePreview();
                
                // Notify user
                showToast('Configuration imported successfully!', 'success');
            } catch (error) {
                console.error("Error applying configuration:", error);
                showErrorModal(`Error applying configuration: ${error.message}`);
            }
        }
        
        // Helper function to reset form to defaults
        function resetFormToDefaults() {
            // Basic settings
            document.getElementById('wireguardStartPort').value = 51000;
            document.getElementById('wireguardProfiles').value = 30;
            document.getElementById('serverAddr').value = '';
            document.getElementById('dns').value = '1.1.1.1';
            
            // Time settings
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('tickTime').value = 120;
            
            // Game settings
            document.getElementById('flagExpireTicks').value = 5;
            document.getElementById('initialServiceScore').value = 5000;
            document.getElementById('maxFlagsPerRequest').value = 3000;
            document.getElementById('submissionTimeout').value = 0.03;
            
            // Resource settings
            document.getElementById('networkLimitBandwidth').value = '20mbit';
            document.getElementById('maxVmCpus').value = '1';
            document.getElementById('maxVmMem').value = '2G';
            document.getElementById('enableDiskLimit').checked = false;
            document.getElementById('diskLimitField').style.display = 'none';
            document.getElementById('maxDiskSize').value = '30G';
            
            // Server settings
            document.getElementById('gameserverToken').value = '';
            document.getElementById('unsafePrivileged').checked = false;
            document.getElementById('exposeGameserver').checked = false;
            document.getElementById('gameserverPortField').style.display = 'none';
            document.getElementById('gameserverExposedPort').value = '127.0.0.1:8888';
            document.getElementById('debugMode').checked = false;
            document.getElementById('pinDataAdded').checked = false;
        }
        
        // Helper function to format date for datetime-local input
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Reset import form when modal is hidden
        document.getElementById('importModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('importConfigFile').value = '';
            document.getElementById('importConfigTextarea').value = '';
        });
    </script>
    
    <!-- Add Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Add compression library -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</body>
</html>