<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTFBox Configuration Editor</title>
    <link rel="icon" href="./images/teams/ctfbox-player.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #3b56d9;
            --primary-hover: #2941b8;
            --secondary: #1a1b2e;
            --accent: #38b6e0;
            --success: #05b889;
            --danger: #d93f63;
            --warning: #e8bc54;
            --dark-bg: #121220;
            --card-bg: #1c1f32;
            --input-bg: #12121e;
            --border-color: #383d5d;
            --text-primary: #eaeaea;
            --text-secondary: #9ba3af;
            --team-card-bg: #181a28;
            --nop-team-border: #3a9188;  /* Un verde-blu tenue (teal) */
            --nop-team-gradient-start: rgba(58, 145, 136, 0.12);
            --nop-team-gradient-mid: rgba(58, 145, 136, 0.06);
            --nop-team-gradient-end: rgba(58, 145, 136, 0.02);
            --code-bg: #0e0e18;
        }
        
        body {
            padding: 30px 20px;
            background-color: var(--dark-bg);
            color: var(--text-primary);
        }
        .container {
            max-width: 1400px;
            background-color: #161726;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 0 40px rgba(0,0,0,0.7);
            margin: 0 auto;
        }
        
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background-color: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 2rem;
            font-weight: 500;
        }
        
        .card-body {
            padding: 2rem;
        }
        
        .section-card {
            margin-bottom: 1.5rem;
        }
        
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .section-title {
            color: var(--accent);
            font-weight: 600;
            letter-spacing: 0.5px;
            font-size: 1.35rem;
            margin-bottom: 0.5rem;
        }
        
        .form-control, .form-select, .btn {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            transition: all 0.2s ease;
            min-height: 42px;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--input-bg);
            border-color: var(--accent);
            box-shadow: 0 0 0 0.25rem rgba(76, 201, 240, 0.25);
            color: var(--text-primary);
        }
        
        .form-floating > label {
            color: var(--text-secondary);
            padding: 1rem 0.75rem;
        }
        
        .form-floating > .form-control:focus ~ label,
        .form-floating > .form-control:not(:placeholder-shown) ~ label {
            color: var(--accent);
        }
        
        .form-floating > .form-control {
            padding-top: 1.5rem;
            padding-bottom: 0.5rem;
            height: calc(3.5rem + 2px);
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-success {
            background-color: var(--success);
            border-color: var(--success);
        }
        
        .btn-outline-success {
            border-color: var(--success);
            color: var(--success);
        }
        
        .btn-outline-success:hover {
            background-color: var(--success);
        }
        
        .btn-outline-info {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .btn-outline-info:hover {
            background-color: var(--accent);
            border-color: var(--accent);
        }
        
        .btn-outline-danger {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .btn-outline-danger:hover {
            background-color: var(--danger);
        }
        
        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            min-height: 54px;
        }
        
        .team-card {
            background-color: var(--team-card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.75rem;
            transition: all 0.3s ease;
            margin-bottom: 0;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .team-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }
        
        .team-card.nop-team {
            border: 1px solid var(--nop-team-border);
            border-left: 4px solid var(--nop-team-border);
            background: linear-gradient(135deg, var(--nop-team-gradient-start) 0%, var(--nop-team-gradient-mid) 40%, var(--nop-team-gradient-end) 100%);
            box-shadow: 0 8px 24px rgba(58, 145, 136, 0.15);
        }
        
        .team-card.nop-team .team-title {
            color: var(--nop-team-border);
            font-weight: 700;
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .team-title {
            font-size: 1.35rem;
            font-weight: 600;
            color: var(--accent);
            margin: 0;
        }
        
        .team-id-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom-left-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .team-image-container {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1.25rem;
            margin-top: 1rem;
        }
        
        /* Add responsive styles for team image container on mobile */
        @media (max-width: 576px) {
            .team-image-preview-wrap {
                display: flex;
                justify-content: center;
                margin-bottom: 1rem;
            }
            
            .team-image-controls {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            
            .team-image-controls .btn {
                margin-bottom: 0.5rem;
                padding: 0.5rem 1rem;
                height: auto;
            }
            
            .team-image-container .d-flex {
                flex-direction: column;
            }
        }
        
        .json-preview {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .key {
            color: var(--accent);
        }
        
        .string {
            color: var(--success);
        }
        
        .number {
            color: var(--warning);
        }
        
        .boolean {
            color: var(--primary);
        }
        
        .null {
            color: var(--danger);
        }
        
        .form-check-input[type="checkbox"] {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        
        .form-check-input:checked[type="checkbox"] {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .form-check-label {
            cursor: pointer;
            font-size: 1rem;
            padding-left: 0.5rem;
            line-height: 1.2;
        }
        
        .form-switch .form-check-input {
            width: 2em;
            height: 1.25em;
            margin-top: 0;
            margin-right: 0.75rem;
        }
        
        .form-check-centered {
            min-height: 42px;
            display: flex;
            align-items: center;
            padding-left: 0;
        }
        
        .form-check-centered .form-check-input {
            margin-left: 0;
            margin-right: 0.75rem;
        }
        
        .form-check-centered .form-check-label {
            padding-left: 0;
        }
        
        .form-check-centered small {
            display: block;
            margin-top: 0.25rem;
            padding-left: 2.5rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .form-floating {
            margin-bottom: 1rem;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            height: 100%;
            padding: 0.5rem 0;
        }
        
        .toast {
            background-color: var(--dark-bg);
            border-left: 4px solid var(--primary);
        }
        
        .toast.bg-success {
            border-left-color: var(--success);
        }
        
        .mb-4 {
            margin-bottom: 1.5rem !important;
        }
        
        .mb-3 {
            margin-bottom: 1rem !important;
        }
        
        .mt-4 {
            margin-top: 2.5rem !important;
        }
        
        .row {
            margin-bottom: 1rem;
        }
        
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .team-container-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        
        .btn, .form-control, .card {
            transition: all 0.2s ease;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--input-bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
        
        @media (max-width: 992px) {
            .grid-layout {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .team-container-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .container {
                padding: 25px 15px;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            .row{
                gap: 20px;
            }
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            border-bottom-color: var(--border-color);
            padding: 1.25rem 1.5rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-top-color: var(--border-color);
            padding: 1.25rem 1.5rem;
        }
        
        .section-full-width {
            grid-column: 1 / -1;
        }
        
        .header {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .footer {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .btn-reset {
            background-color: var(--secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-reset:hover {
            background-color: #242538;
            border-color: var(--border-color);
            color: var(--danger);
        }

        .floating-reset-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .floating-reset-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            background-color: #242538;
            color: var(--danger);
        }

        .floating-reset-btn svg {
            width: 24px;
            height: 24px;
        }

        @media (max-width: 768px) {
            .floating-reset-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }
        }

        .toast-container {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: var(--card-bg);
            border-left: 4px solid var(--primary);
            color: var(--text-primary);
            padding: 10px;
            min-width: 280px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            opacity: 1;
        }

        .toast.bg-success {
            border-left-color: var(--success);
            background-color: rgba(5, 184, 137, 0.2);
        }

        .toast-body {
            padding: 0.5rem 0.5rem;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .toast-container {
                bottom: 80px;
                left: 20px;
                right: 20px;
                align-items: center;
            }
            
            .toast {
                width: 90%;
                max-width: 350px;
            }
        }

        /* Hide number input spinners for grace time */
        .grace-time-input::-webkit-inner-spin-button, 
        .grace-time-input::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        
        .grace-time-input {
            -moz-appearance: textfield;
            text-align: center;
        }
        
        .grace-time-group .input-group-text {
            padding-left: 6px;
            padding-right: 6px;
            font-weight: 400;
            background-color: var(--secondary);
            color: var(--text-secondary);
            border-color: var(--border-color);
        }
        
        .grace-time-label {
            font-weight: 400;
            margin-bottom: 0.3rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-center">CTFBox Configuration Editor</h1>
            <p class="text-center text-muted">Generate configuration file for CTFBox</p>
        </div>
        
        <div class="grid-layout">
            <div class="section card section-card">
                <div class="card-header">
                    <h3 class="section-title mb-0">Basic Settings</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="wireguardPort" value="51000" min="1">
                                <label for="wireguardPort">Wireguard Port</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="wireguardProfiles" value="30" min="1">
                                <label for="wireguardProfiles">Wireguard Profiles</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="serverAddr" required>
                                <label for="serverAddr">Server Address (Required)</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="dns" value="1.1.1.1">
                                <label for="dns">DNS Server</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section card section-card">
                <div class="card-header">
                    <h3 class="section-title mb-0 d-flex align-items-center">
                        Time Settings
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" 
                             class="bi bi-info-circle ms-2 text-info cursor-pointer" 
                             viewBox="0 0 16 16" data-bs-toggle="modal" data-bs-target="#timeSettingsInfoModal" 
                             style="cursor: pointer;">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="datetime-local" class="form-control" id="startTime">
                                <label for="startTime">Start Time (Optional)</label>
                            </div>
                            <div class="time-note">Uses your current time zone</div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="datetime-local" class="form-control" id="endTime">
                                <label for="endTime">End Time (Optional)</label>
                            </div>
                            <div class="time-note">Uses your current time zone</div>
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="graceTimeInputs" class="form-label grace-time-label">Grace Time</label>
                            <input type="hidden" id="graceTime" value="300">
                            <div class="d-flex align-items-center gap-2" id="graceTimeInputs">
                                <div class="input-group grace-time-group">
                                    <input type="number" class="form-control grace-time-input" id="graceTimeHours" value="0" min="0" onchange="updateGraceTime()">
                                    <span class="input-group-text">h</span>
                                </div>
                                <div class="input-group grace-time-group">
                                    <input type="number" class="form-control grace-time-input" id="graceTimeMinutes" value="5" min="0" max="59" onchange="updateGraceTime()">
                                    <span class="input-group-text">m</span>
                                </div>
                                <div class="input-group grace-time-group">
                                    <input type="number" class="form-control grace-time-input" id="graceTimeSeconds" value="0" min="0" max="59" onchange="updateGraceTime()">
                                    <span class="input-group-text">s</span>
                                </div>
                            </div>
                            <small class="text-muted">Time players can access their own VMs before the competition starts</small>
                        </div>
                        <div class="col-lg-6 mt-3">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="tickTime" value="120" min="1">
                                <label for="tickTime">Tick Time (seconds)</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section card section-card">
                <div class="card-header">
                    <h3 class="section-title mb-0">Game Settings</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="flagExpireTicks" value="5" min="1">
                                <label for="flagExpireTicks">Flag Expire Ticks</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="initialServiceScore" value="5000" min="0">
                                <label for="initialServiceScore">Initial Service Score</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="maxFlagsPerRequest" value="3000" min="1">
                                <label for="maxFlagsPerRequest">Max Flags Per Request</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="submissionTimeout" value="0.03" min="0" step="0.01">
                                <label for="submissionTimeout">Submission Timeout</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section card section-card">
                <div class="card-header">
                    <h3 class="section-title mb-0">Resource Settings</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="networkLimitBandwidth" value="50mbit">
                                <label for="networkLimitBandwidth">Network Limit Bandwidth</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="maxVmCpus" value="1">
                                <label for="maxVmCpus">Max VM CPUs</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="maxVmMem" value="2G">
                                <label for="maxVmMem">Max VM Memory</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-check form-switch form-switch-lg d-flex align-items-center" style="height: 42px; margin-bottom: 0.5rem;">
                                <input class="form-check-input me-2" type="checkbox" id="enableDiskLimit">
                                <label class="form-check-label" for="enableDiskLimit">Enable Disk Limit</label>
                            </div>
                            <div id="diskLimitField" style="display: none; margin-top: 0.5rem;">
                                <div class="form-floating mb-2">
                                    <input type="text" class="form-control" id="maxDiskSize" value="30G">
                                    <label for="maxDiskSize">Max Disk Size</label>
                                </div>
                                <small class="text-muted d-block" style="font-size: 0.85rem; line-height: 1.2;">
                                    Note: Requires XFS filesystem with pquota enabled on the host
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section card section-card section-full-width">
                <div class="card-header">
                    <h3 class="section-title mb-0">Server Settings</h3>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="gameserverToken" placeholder="Auto-generated if empty">
                                <label for="gameserverToken">Gameserver Token (Optional)</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="checkbox-wrapper">
                                <div class="form-check form-switch form-switch-lg">
                                    <input class="form-check-input" type="checkbox" id="debugMode">
                                    <label class="form-check-label" for="debugMode">Debug Mode</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-6 mb-lg-0">
                            <div class="card h-100">
                                <div class="card-header d-flex align-items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-hdd-network me-2" viewBox="0 0 16 16">
                                        <path d="M4.5 5.1a.5.5 0 0 0-.5.5v1a.5.5 0 0 1-1 0v-1A1.5 1.5 0 0 1 4.5 4h7A1.5 1.5 0 0 1 13 5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 0-.5-.5h-7ZM4.5 10.1a.5.5 0 0 0-.5.5v1a.5.5 0 0 1-1 0v-1A1.5 1.5 0 0 1 4.5 9h7A1.5 1.5 0 0 1 13 10.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 0-.5-.5h-7Z"/>
                                        <path d="M2 2a2 2 0 0 0-2 2v1a2 2 0 0 0 1 1.73V7.5h-.5A1.5 1.5 0 0 0 0 9v1.5a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 10.5V9a1.5 1.5 0 0 0-1.5-1.5H14V6.73A2 2 0 0 0 15 5V3a2 2 0 0 0-2-2H2Zm.5 3a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1Zm2 0a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1Zm-1.5 7a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1Zm2 0a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1ZM9 3a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/>
                                    </svg>
                                    <span class="fs-5">Gameserver Options</span>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch form-check-centered mb-3 row">
                                        <div class="col-lg-6 mb-lg-0" style="display: flex; align-items: center;">
                                            <input class="form-check-input" type="checkbox" id="unsafePrivileged">
                                            <label class="form-check-label fs-5" for="unsafePrivileged">Use Privileged Mode (Not Recommended)</label>
                                        </div>
                                        <small class="col-lg-6 mb-lg-0">
                                            Containers run in privileged mode instead of sysbox. Less secure, no sysbox needed, for testing only.
                                        </small>
                                    </div>
                                    <div class="form-check form-switch form-check-centered mb-3">
                                        <input class="form-check-input" type="checkbox" id="exposeGameserver">
                                        <label class="form-check-label fs-5" for="exposeGameserver">Expose Gameserver</label>
                                    </div>
                                    <div id="gameserverPortField" style="display: none;">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="gameserverExposedPort" value="127.0.0.1:8888">
                                            <label for="gameserverExposedPort">Gameserver Port</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card h-100">
                                <div class="card-header d-flex align-items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-key me-2" viewBox="0 0 16 16">
                                        <path d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 10h-.535A4 4 0 0 1 0 8zm4-3a3 3 0 1 0 2.712 4.285A.5.5 0 0 1 7.163 9h.63l.853-.854a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.793-.793-1-1h-6.63a.5.5 0 0 1-.451-.285A3 3 0 0 0 4 5z"/>
                                        <path d="M4 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                    </svg>
                                    <span class="fs-5">Credential Server Options</span>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch form-check-centered mb-3">
                                        <input class="form-check-input" type="checkbox" id="enableCredentialServer">
                                        <label class="form-check-label fs-5" for="enableCredentialServer">Enable Credential Server</label>
                                    </div>
                                    <div id="credentialServerField" style="display: none;">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="credentialServerPort" value="0.0.0.0:4040">
                                            <label for="credentialServerPort">Credential Server Address</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section card section-card section-full-width">
                <div class="card-header">
                    <h3 class="section-title mb-0">Team Configuration</h3>
                </div>
                <div class="card-body">
                    <div class="row align-items-center mb-4" style="justify-content: center;">
                        <div class="col-lg-4 col-lg-3">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="numberOfTeams" value="4" min="1" max="249">
                                <label for="numberOfTeams">Number of Teams</label>
                            </div>
                        </div>
                        <div class="col-lg-4 col-lg-3">
                            <div class="form-check form-switch form-switch-lg form-check-centered" style="justify-content: center;">
                                <input class="form-check-input" type="checkbox" id="enableNopTeam">
                                <label class="form-check-label fs-5" for="enableNopTeam">Enable NOP Team</label>
                            </div>
                        </div>
                        <div class="col-lg-4 col-lg-3">
                            <button class="btn btn-primary w-100" id="generateTeams">Generate Teams</button>
                        </div>
                    </div>
                    
                    <div class="team-actions d-flex flex-wrap justify-content-between align-items-center mb-4 mt-4">
                        <div>
                            <button class="btn btn-outline-success btn-lg" id="addSingleTeam">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle me-2" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                </svg> Add Team
                            </button>
                        </div>
                        <span class="text-muted fs-5"><span id="teamCountDisplay" class="badge bg-primary">0</span> teams configured</span>
                    </div>
                    
                    <div id="teamsContainer" class="team-container-grid">
                        <!-- Teams will be generated here -->
                    </div>
                </div>
            </div>
            
            <div class="section card section-card section-full-width">
                <div class="card-header">
                    <div class="preview-header d-flex flex-wrap justify-content-between align-items-center">
                        <h3 class="section-title mb-0">Configuration Preview</h3>
                        <div class="preview-actions d-flex flex-wrap align-items-center gap-3">
                            <div class="form-check form-switch form-switch-lg me-2">
                                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                <label class="form-check-label" for="autoRefresh">Auto-Refresh</label>
                            </div>
                            <button class="btn btn-outline-info" id="copyConfig">Copy to Clipboard</button>
                            <button class="btn btn-outline-success" id="copyCompressedConfig">Copy Compressed Config</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="json-preview">
                        <pre id="configPreview">// Configuration will be shown here when you modify settings</pre>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-3 d-lg-flex justify-content-lg-between mb-4">
            <div class="d-grid gap-3 d-lg-flex">
                <button class="btn btn-primary btn-lg flex-grow-1" id="generateConfig">Generate Configuration</button>
                <button class="btn btn-outline-info btn-lg" id="importConfig">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-2" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg> Import
                </button>
            </div>
            <button class="btn btn-success btn-lg" id="downloadConfig" aria-label="Download Configuration">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg> Download
            </button>
        </div>
    </div>
    
    <!-- Add the floating reset button -->
    <button class="floating-reset-btn" id="resetConfig" title="Reset Configuration">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
            <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
        </svg>
    </button>
    
    <div class="toast-container">
    </div>

    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="errorModalBody">
                    An error occurred.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">Import Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="import-options">
                        <div class="import-option">
                            <div class="import-option-title">Option 1: Upload JSON File</div>
                            <div class="mb-3">
                                <input class="form-control" type="file" id="importConfigFile" accept="application/json">
                            </div>
                        </div>
                        
                        <div class="import-option">
                            <div class="import-option-title">Option 2: Paste JSON or Compressed Base64</div>
                            <div class="mb-3">
                                <textarea class="form-control" id="importConfigTextarea" placeholder="Paste your configuration JSON or compressed Base64 string here"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle me-2" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                        You can import a regular JSON configuration file or a compressed Base64 string. This will overwrite your current settings.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="processImport">Import Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resetConfirmModal" tabindex="-1" aria-labelledby="resetConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetConfirmModalLabel">Confirm Reset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to reset all configuration settings to default values? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmReset">Reset Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Settings Info Modal with enhanced layout -->
    <div class="modal fade" id="timeSettingsInfoModal" tabindex="-1" aria-labelledby="timeSettingsInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="timeSettingsInfoModalLabel">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-history me-2" viewBox="0 0 16 16">
                            <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
                            <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                        Network States Timeline
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3">
                    <!-- Timeline visualization -->
                    <div class="timeline-viz mb-4 px-4 py-3" style="background-color: var(--input-bg); border-radius: 8px;">
                        <div class="d-flex align-items-center justify-content-between position-relative mx-3" style="height: 60px;">
                            <!-- Timeline bar -->
                            <div class="position-absolute" style="height: 4px; background-color: var(--border-color); left: 0; right: 0; top: 50%;"></div>
                            
                            <!-- Timeline points -->
                            <div class="position-relative" style="z-index: 1;">
                                <div class="rounded-circle bg-danger" style="width: 14px; height: 14px;"></div>
                                <div class="position-absolute text-center" style="font-size: 0.75rem; width: 100px; left: -45px; top: 24px;">Pre-Grace</div>
                            </div>
                            
                            <div class="position-relative" style="z-index: 1;">
                                <div class="rounded-circle bg-warning" style="width: 12px; height: 12px;"></div>
                                <div class="position-absolute text-center" style="font-size: 0.75rem; width: 100px; left: -45px; top: 18px;">Grace Period</div>
                            </div>
                            
                            <div class="position-relative" style="z-index: 1;">
                                <div class="rounded-circle bg-success" style="width: 12px; height: 12px;"></div>
                                <div class="position-absolute text-center" style="font-size: 0.75rem; width: 100px; left: -45px; top: 18px;">Competition</div>
                            </div>
                            
                            <div class="position-relative" style="z-index: 1;">
                                <div class="rounded-circle bg-secondary" style="width: 12px; height: 12px;"></div>
                                <div class="position-absolute text-center" style="font-size: 0.75rem; width: 100px; left: -45px; top: 18px;">Post-End</div>
                            </div>
                        </div>
                        
                        <!-- Timeline labels -->
                        <div class="d-flex justify-content-between text-muted px-1 mt-4" style="font-size: 0.7rem; margin-left: 13px;">
                            <span>-âˆž</span>
                            <span>Start Time - Grace</span>
                            <span>Start Time</span>
                            <span>End Time</span>
                        </div>
                    </div>
                    
                    <h6 class="mb-2" style="color: var(--accent);">Grace Time Explained</h6>
                    <p class="mb-3">Grace time is a preparation period before the competition officially begins, allowing teams to set up their infrastructure without attacks.</p>
                    
                    <!-- Network states with detailed explanations -->
                    <div class="state-cards">
                        <div class="card mb-2 border-danger">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-danger rounded-circle me-2 flex-shrink-0" style="width: 10px; height: 10px;"></div>
                                    <h6 class="mb-0 text-danger fw-bold">Frozen Network</h6>
                                </div>
                                <div class="ms-3 mt-1" style="font-size: 0.85rem;">
                                    <p class="mb-1"><strong>When:</strong> Before <code>start_time - grace_time</code></p>
                                    <p class="mb-0"><strong>Access:</strong> Players can only connect to the gameserver, not to any VMs</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-2 border-warning">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning rounded-circle me-2 flex-shrink-0" style="width: 10px; height: 10px;"></div>
                                    <h6 class="mb-0 text-warning fw-bold">Locked Network (Grace Period)</h6>
                                </div>
                                <div class="ms-3 mt-1" style="font-size: 0.85rem;">
                                    <p class="mb-1"><strong>When:</strong> Between <code>start_time - grace_time</code> and <code>start_time</code></p>
                                    <p class="mb-0"><strong>Access:</strong> Teams can only access their own VMs, not other teams' services</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-2 border-success">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success rounded-circle me-2 flex-shrink-0" style="width: 10px; height: 10px;"></div>
                                    <h6 class="mb-0 text-success fw-bold">Unlocked Network (Competition)</h6>
                                </div>
                                <div class="ms-3 mt-1" style="font-size: 0.85rem;">
                                    <p class="mb-1"><strong>When:</strong> Between <code>start_time</code> and <code>end_time</code></p>
                                    <p class="mb-0"><strong>Access:</strong> Full network access, teams can attack other teams' services</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-2">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-secondary rounded-circle me-2 flex-shrink-0" style="width: 10px; height: 10px;"></div>
                                    <h6 class="mb-0 fw-bold">Finished</h6>
                                </div>
                                <div class="ms-3 mt-1" style="font-size: 0.85rem;">
                                    <p class="mb-1"><strong>When:</strong> After <code>end_time</code></p>
                                    <p class="mb-0"><strong>Access:</strong> Teams can only access their own VMs, competition is over</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3 mb-0 py-2" style="font-size: 0.85rem;">
                        <strong>Note:</strong> If no <code>start_time</code> is set, the competition starts after <code>grace_time</code> seconds from CTFBox startup.
                    </div>
                </div>
                <div class="modal-footer pt-2 pb-2">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        let updatePreviewDebounced = debounce(function() {
            if (document.getElementById('autoRefresh').checked) {
                updatePreview();
            }
        }, 300);

        // Add a debounced function for saving state
        let saveStateDebounced = debounce(function() {
            saveStateToLocalStorage();
        }, 500);

        function saveStateToLocalStorage() {
            try {
                const formData = {
                    wireguardPort: document.getElementById('wireguardPort').value,
                    wireguardProfiles: document.getElementById('wireguardProfiles').value,
                    serverAddr: document.getElementById('serverAddr').value,
                    dns: document.getElementById('dns').value,
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    graceTimeHours: document.getElementById('graceTimeHours').value,
                    graceTimeMinutes: document.getElementById('graceTimeMinutes').value,
                    graceTimeSeconds: document.getElementById('graceTimeSeconds').value,
                    graceTime: document.getElementById('graceTime').value,
                    tickTime: document.getElementById('tickTime').value,
                    flagExpireTicks: document.getElementById('flagExpireTicks').value,
                    initialServiceScore: document.getElementById('initialServiceScore').value,
                    maxFlagsPerRequest: document.getElementById('maxFlagsPerRequest').value,
                    submissionTimeout: document.getElementById('submissionTimeout').value,
                    networkLimitBandwidth: document.getElementById('networkLimitBandwidth').value,
                    maxVmCpus: document.getElementById('maxVmCpus').value,
                    maxVmMem: document.getElementById('maxVmMem').value,
                    enableDiskLimit: document.getElementById('enableDiskLimit').checked,
                    maxDiskSize: document.getElementById('maxDiskSize').value,
                    gameserverToken: document.getElementById('gameserverToken').value,
                    unsafePrivileged: document.getElementById('unsafePrivileged').checked,
                    exposeGameserver: document.getElementById('exposeGameserver').checked,
                    gameserverExposedPort: document.getElementById('gameserverExposedPort').value,
                    enableCredentialServer: document.getElementById('enableCredentialServer').checked,
                    credentialServerPort: document.getElementById('credentialServerPort').value,
                    debugMode: document.getElementById('debugMode').checked,
                    numberOfTeams: document.getElementById('numberOfTeams').value,
                    enableNopTeam: document.getElementById('enableNopTeam').checked,
                    autoRefresh: document.getElementById('autoRefresh').checked
                };

                // Get teams data
                formData.teams = [];
                document.querySelectorAll('.team-card').forEach(teamCard => {
                    const teamId = parseInt(teamCard.getAttribute('data-team-id'));
                    if (isNaN(teamId)) return;
                    
                    const teamData = {
                        id: teamId,
                        name: document.getElementById(`teamName-${teamId}`)?.value || `Team ${teamId}`,
                        token: document.getElementById(`teamToken-${teamId}`)?.value || "",
                        nop: document.getElementById(`teamNop-${teamId}`)?.checked || false,
                        image: document.getElementById(`teamImage-${teamId}`)?.value || ""
                    };
                    
                    formData.teams.push(teamData);
                });

                localStorage.setItem('ctfboxEditorState', JSON.stringify(formData));
                console.log('State saved to localStorage');
            } catch (error) {
                console.error('Error saving state to localStorage:', error);
            }
        }

        function loadStateFromLocalStorage() {
            try {
                const savedState = localStorage.getItem('ctfboxEditorState');
                if (!savedState) return false;
                
                const formData = JSON.parse(savedState);
                
                // Load basic form fields
                if (formData.wireguardPort) document.getElementById('wireguardPort').value = formData.wireguardPort;
                if (formData.wireguardProfiles) document.getElementById('wireguardProfiles').value = formData.wireguardProfiles;
                if (formData.serverAddr) document.getElementById('serverAddr').value = formData.serverAddr;
                if (formData.dns) document.getElementById('dns').value = formData.dns;
                if (formData.startTime) document.getElementById('startTime').value = formData.startTime;
                if (formData.endTime) document.getElementById('endTime').value = formData.endTime;
                if (formData.graceTimeHours !== undefined) {
                    document.getElementById('graceTimeHours').value = formData.graceTimeHours;
                }
                if (formData.graceTimeMinutes !== undefined) {
                    document.getElementById('graceTimeMinutes').value = formData.graceTimeMinutes;
                }
                if (formData.graceTimeSeconds !== undefined) {
                    document.getElementById('graceTimeSeconds').value = formData.graceTimeSeconds;
                } else if (formData.graceTime) {
                    setGraceTimeInputs(parseInt(formData.graceTime));
                }
                if (formData.tickTime) document.getElementById('tickTime').value = formData.tickTime;
                if (formData.flagExpireTicks) document.getElementById('flagExpireTicks').value = formData.flagExpireTicks;
                if (formData.initialServiceScore) document.getElementById('initialServiceScore').value = formData.initialServiceScore;
                if (formData.maxFlagsPerRequest) document.getElementById('maxFlagsPerRequest').value = formData.maxFlagsPerRequest;
                if (formData.submissionTimeout) document.getElementById('submissionTimeout').value = formData.submissionTimeout;
                if (formData.networkLimitBandwidth) document.getElementById('networkLimitBandwidth').value = formData.networkLimitBandwidth;
                if (formData.maxVmCpus) document.getElementById('maxVmCpus').value = formData.maxVmCpus;
                if (formData.maxVmMem) document.getElementById('maxVmMem').value = formData.maxVmMem;
                
                if (formData.enableDiskLimit !== undefined) {
                    document.getElementById('enableDiskLimit').checked = formData.enableDiskLimit;
                    document.getElementById('diskLimitField').style.display = formData.enableDiskLimit ? 'block' : 'none';
                }
                if (formData.maxDiskSize) document.getElementById('maxDiskSize').value = formData.maxDiskSize;
                if (formData.gameserverToken) document.getElementById('gameserverToken').value = formData.gameserverToken;
                if (formData.unsafePrivileged !== undefined) document.getElementById('unsafePrivileged').checked = formData.unsafePrivileged;
                if (formData.exposeGameserver !== undefined) {
                    document.getElementById('exposeGameserver').checked = formData.exposeGameserver;
                    document.getElementById('gameserverPortField').style.display = formData.exposeGameserver ? 'block' : 'none';
                }
                if (formData.gameserverExposedPort) document.getElementById('gameserverExposedPort').value = formData.gameserverExposedPort;
                if (formData.enableCredentialServer !== undefined) {
                    document.getElementById('enableCredentialServer').checked = formData.enableCredentialServer;
                    document.getElementById('credentialServerField').style.display = formData.enableCredentialServer ? 'block' : 'none';
                }
                if (formData.credentialServerPort) document.getElementById('credentialServerPort').value = formData.credentialServerPort;
                if (formData.debugMode !== undefined) document.getElementById('debugMode').checked = formData.debugMode;
                if (formData.numberOfTeams) document.getElementById('numberOfTeams').value = formData.numberOfTeams;
                if (formData.enableNopTeam !== undefined) document.getElementById('enableNopTeam').checked = formData.enableNopTeam;
                if (formData.autoRefresh !== undefined) document.getElementById('autoRefresh').checked = formData.autoRefresh;
                
                // Handle teams if they exist
                if (formData.teams && Array.isArray(formData.teams) && formData.teams.length > 0) {
                    document.getElementById('teamsContainer').innerHTML = '';
                    
                    formData.teams.forEach(team => {
                        const teamCard = createTeamCard(team.id, team.name, team.nop);
                        teamCard.setAttribute('data-team-id', team.id);
                        document.getElementById('teamsContainer').appendChild(teamCard);
                        
                        document.getElementById(`teamName-${team.id}`).value = team.name;
                        if (team.nop !== undefined && team.id !== 0) document.getElementById(`teamNop-${team.id}`).checked = team.nop;
                        if (team.token) document.getElementById(`teamToken-${team.id}`).value = team.token;
                        if (team.image) {
                            document.getElementById(`teamImage-${team.id}`).value = team.image;
                            updateTeamImagePreview(team.image, team.id);
                        }
                        
                        updateTeamTitle(team.id, team.name);
                        updateTeamNopStatus(team.id, team.nop);
                    });
                    
                    updateTeamCount();
                }
                
                return true;
            } catch (error) {
                console.error('Error loading state from localStorage:', error);
                return false;
            }
        }

        function clearLocalStorage() {
            localStorage.removeItem('ctfboxEditorState');
            console.log('Local storage cleared');
        }

        function resetWithConfirmation() {
            const resetModal = new bootstrap.Modal(document.getElementById('resetConfirmModal'));
            resetModal.show();
        }

        function resetConfiguration() {
            resetFormToDefaults();
            document.getElementById('teamsContainer').innerHTML = '';
            generateTeamFields();
            updateTeamCount();
            updatePreview();
            clearLocalStorage();
            showToast('Configuration has been reset to default values');
        }

        function showToast(message, type = 'success') {
            const toastId = `toast-${Date.now()}`;
            const toastElement = document.createElement('div');
            toastElement.className = `toast align-items-center border-0 ${type === 'success' ? 'bg-success' : ''}`;
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            toastElement.id = toastId;
            
            toastElement.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            document.querySelector('.toast-container').appendChild(toastElement);
            
            const toast = new bootstrap.Toast(toastElement, {
                animation: true,
                autohide: true,
                delay: 3000
            });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
        
        function showSuccessModal(message) {
            showToast(message, 'success');
        }
        
        function showErrorModal(message) {
            const modalBody = document.getElementById('errorModalBody');
            modalBody.textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Load state from local storage if available
            const stateLoaded = loadStateFromLocalStorage();
            if (stateLoaded) {
                console.log('State loaded from localStorage');
                updatePreview();
            }

            document.getElementById('enableDiskLimit').addEventListener('change', function() {
                document.getElementById('diskLimitField').style.display = this.checked ? 'block' : 'none';
                updatePreviewDebounced();
                saveStateDebounced();
            });
            
            document.getElementById('exposeGameserver').addEventListener('change', function() {
                document.getElementById('gameserverPortField').style.display = this.checked ? 'block' : 'none';
                updatePreviewDebounced();
                saveStateDebounced();
            });

            document.getElementById('enableCredentialServer').addEventListener('change', function() {
                document.getElementById('credentialServerField').style.display = this.checked ? 'block' : 'none';
                updatePreviewDebounced();
                saveStateDebounced();
            });
            
            document.getElementById('generateTeams').addEventListener('click', function() {
                generateTeamFields();
                updatePreviewDebounced();
                saveStateDebounced();
            });
            
            document.getElementById('addSingleTeam').addEventListener('click', function() {
                addSingleTeam();
                updatePreviewDebounced();
                saveStateDebounced();
            });

            document.getElementById('resetConfig').addEventListener('click', resetWithConfirmation);
            document.getElementById('confirmReset').addEventListener('click', function() {
                const resetModal = bootstrap.Modal.getInstance(document.getElementById('resetConfirmModal'));
                resetModal.hide();
                resetConfiguration();
            });

            document.getElementById('generateConfig').addEventListener('click', function() {
                try {
                    const config = buildConfigObject();
                    const jsonStr = JSON.stringify(config, null, 4);
                    const coloredJson = syntaxHighlight(jsonStr);
                    document.getElementById('configPreview').innerHTML = coloredJson;
                    showToast('Configuration generated successfully!');
                } catch (error) {
                    console.error(error);
                    showErrorModal(`Error: ${error.message}`);
                }
            });
            
            document.getElementById('downloadConfig').addEventListener('click', function() {
                try {
                    let config;
                    try {
                        config = buildConfigObject();
                    } catch (error) {
                        console.error(error);
                        showErrorModal(`Cannot download: ${error.message}`);
                        return;
                    }
                    
                    downloadJSON(config, 'config.json');
                    showToast('Configuration downloaded successfully!');
                } catch (error) {
                    console.error(error);
                    showErrorModal(`Error: ${error.message}`);
                }
            });
            
            document.getElementById('copyConfig').addEventListener('click', copyConfigToClipboard);
            
            document.getElementById('copyCompressedConfig').addEventListener('click', copyCompressedConfigToClipboard);
            
            document.getElementById('importConfig').addEventListener('click', function() {
                const importModal = new bootstrap.Modal(document.getElementById('importModal'));
                importModal.show();
            });
            
            document.getElementById('processImport').addEventListener('click', processImportConfig);
            
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    updatePreview();
                }
            });
            
            generateTeamFields();
            
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.querySelectorAll) {
                                setupFormListeners(node);
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.getElementById('teamsContainer'), {
                childList: true,
                subtree: true
            });
            
            setupFormListeners(document);
            
            if (document.getElementById('autoRefresh').checked) {
                updatePreview();
            }

            // Initialize grace time inputs on page load
            if (!loadStateFromLocalStorage()) {
                setGraceTimeInputs(300);
            }
        });
        
        function setupFormListeners(rootElement) {
            rootElement.querySelectorAll('input, select, textarea').forEach(element => {
                element.removeEventListener('change', updatePreviewDebounced);
                element.removeEventListener('input', updatePreviewDebounced);
                
                element.addEventListener('change', function() {
                    updatePreviewDebounced();
                    saveStateDebounced();
                });
                
                if (element.type === 'text' || element.type === 'number' || 
                    element.type === 'datetime-local' || element.type === 'textarea') {
                    element.addEventListener('input', function() {
                        updatePreviewDebounced();
                        saveStateDebounced();
                    });
                }
                
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.addEventListener('change', function() {
                        setTimeout(function() {
                            updatePreviewDebounced();
                            saveStateDebounced();
                        }, 0);
                    });
                }
            });
        }

        function generateTeamFields() {
            const numberOfTeams = parseInt(document.getElementById('numberOfTeams').value);
            const enableNopTeam = document.getElementById('enableNopTeam').checked;
            const teamsContainer = document.getElementById('teamsContainer');
            
            const existingTeams = {};
            document.querySelectorAll('.team-card').forEach(teamCard => {
                const teamId = parseInt(teamCard.getAttribute('data-team-id'));
                
                if (isNaN(teamId)) return;
                
                const teamData = {
                    name: document.getElementById(`teamName-${teamId}`)?.value || `Team ${teamId}`,
                    token: document.getElementById(`teamToken-${teamId}`)?.value || "",
                    nop: document.getElementById(`teamNop-${teamId}`)?.checked || false,
                    image: document.getElementById(`teamImage-${teamId}`)?.value || ""
                };
                
                existingTeams[teamId] = teamData;
            });
            
            teamsContainer.innerHTML = '';
            
            let startIndex = enableNopTeam ? 0 : 1;
            let endIndex = enableNopTeam ? numberOfTeams + 1 : numberOfTeams + 1;
            
            if (enableNopTeam) {
                if (existingTeams[0]) {
                    const nopTeamData = existingTeams[0];
                    nopTeamData.nop = true;
                    const nopTeam = createTeamCard(0, nopTeamData.name, true);
                    nopTeam.setAttribute('data-team-id', '0');
                    teamsContainer.appendChild(nopTeam);
                    
                    document.getElementById(`teamToken-0`).value = nopTeamData.token;
                    document.getElementById(`teamImage-0`).value = nopTeamData.image;
                    updateTeamImagePreview(nopTeamData.image, 0);
                } else {
                    const nopTeam = createTeamCard(0, 'Nop Team', true);
                    nopTeam.setAttribute('data-team-id', '0');
                    teamsContainer.appendChild(nopTeam);
                }
            }
            
            for (let i = 1; i <= numberOfTeams; i++) {
                if (existingTeams[i]) {
                    const teamData = existingTeams[i];
                    const team = createTeamCard(i, teamData.name, teamData.nop);
                    team.setAttribute('data-team-id', i.toString());
                    teamsContainer.appendChild(team);
                    
                    document.getElementById(`teamNop-${i}`).checked = teamData.nop;
                    document.getElementById(`teamToken-${i}`).value = teamData.token;
                    document.getElementById(`teamImage-${i}`).value = teamData.image;
                    updateTeamImagePreview(teamData.image, i);
                } else {
                    const team = createTeamCard(i, `Team ${i}`, false);
                    team.setAttribute('data-team-id', i.toString());
                    teamsContainer.appendChild(team);
                }
            }
            
            updatePreviewDebounced();
            updateTeamCount();
        }
        
        function addSingleTeam() {
            const teamsContainer = document.getElementById('teamsContainer');
            
            let highestId = 0;
            document.querySelectorAll('.team-card').forEach(teamCard => {
                const teamId = parseInt(teamCard.getAttribute('data-team-id'));
                if (!isNaN(teamId) && teamId > highestId) {
                    highestId = teamId;
                }
            });
            
            const newTeamId = highestId + 1;
            const team = createTeamCard(newTeamId, `Team ${newTeamId}`, false);
            team.setAttribute('data-team-id', newTeamId.toString());
            teamsContainer.appendChild(team);
            
            setupFormListeners(team);

            updatePreviewDebounced();
            saveStateDebounced();
            updateTeamCount();
        }
        
        function removeTeam(teamId) {
            const teamCard = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (teamCard) {
                if (teamId === 0 && document.getElementById('enableNopTeam').checked) {
                    if (!confirm("This will remove the NOP team, but it may be re-added if 'Enable NOP Team' is still checked. Continue?")) {
                        return;
                    }
                }
                
                teamCard.remove();
                updatePreviewDebounced();
                saveStateDebounced();
            }

            updateTeamCount();
        }
        
        function createTeamCard(id, name, isNop) {
            const card = document.createElement('div');
            card.className = `team-card ${isNop ? 'nop-team' : ''}`;
            card.setAttribute('data-team-id', id.toString());
            
            const idBadge = document.createElement('div');
            idBadge.className = 'team-id-badge';
            idBadge.textContent = id;
            card.appendChild(idBadge);
            
            const header = document.createElement('div');
            header.className = 'team-header';
            
            header.innerHTML = `
                <div class="d-flex align-items-center gap-2">
                    <h5 class="team-title m-0" id="team-title-${id}">${name}</h5>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTeam(${id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
                        </svg> Remove
                    </button>
                </div>
            `;
            
            const content = document.createElement('div');
            content.innerHTML = `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="teamName-${id}" value="${name}" oninput="updateTeamTitle(${id}, this.value)">
                            <label for="teamName-${id}">Team Name</label>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="teamNop-${id}" ${isNop ? 'checked' : ''} ${id === 0 ? 'disabled' : ''} onchange="updateTeamNopStatus(${id}, this.checked)">
                            <label class="form-check-label" for="teamNop-${id}">NOP Team</label>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="teamToken-${id}" placeholder="Auto-generated if empty">
                            <label for="teamToken-${id}">Team Token (Optional)</label>
                        </div>
                    </div>
                </div>
                
                <div class="team-image-container mb-4">
                    <label class="form-label fw-bold">Team Image</label>
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3 team-image-preview-wrap" style="width: 80px; height: 80px; overflow: hidden; border-radius: 5px; background-color: #212529;">
                            <img id="teamImagePreview-${id}" 
                                 src="./images/teams/ctfbox-player.png" 
                                 onerror="this.src='./images/teams/ctfbox-player.png'" 
                                 alt="Team Logo" 
                                 style="width: 100%; height: 100%; object-fit: contain;">
                        </div>
                        <div class="d-flex flex-column team-image-controls">
                            <div class="d-flex mb-2">
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="selectImageFile(${id})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-2" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                                    </svg> Upload
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTeamImage(${id})">Remove</button>
                            </div>
                            <small class="text-muted">Max 1MB, JPG/PNG (via ImgBB)</small>
                        </div>
                    </div>
                    <input type="file" id="teamImageFile-${id}" accept="image/jpeg, image/png" style="display: none;" onchange="uploadTeamImage(this, ${id})">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="teamImage-${id}" value="" oninput="updateTeamImagePreview(this.value, ${id})">
                        <label for="teamImage-${id}">Image URL</label>
                    </div>
                    <div id="uploadProgress-${id}" class="progress mt-2" style="display: none; height: 5px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }
        
        function selectImageFile(teamId) {
            document.getElementById(`teamImageFile-${teamId}`).click();
        }
        
        function uploadTeamImage(fileInput, teamId) {
            if (!fileInput.files || !fileInput.files[0]) return;
            
            const file = fileInput.files[0];
            
            if (file.size > 1024 * 1024) {
                showErrorModal("Image file is too large. Maximum size is 1MB.");
                return;
            }
            
            const progressBar = document.querySelector(`#uploadProgress-${teamId} .progress-bar`);
            document.getElementById(`uploadProgress-${teamId}`).style.display = 'flex';
            progressBar.style.width = '0%';
            
            const formData = new FormData();
            formData.append('image', file);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(`teamImagePreview-${teamId}`).src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            fetch('https://api.imgbb.com/1/upload?key=fd9dbdfc2bd2f6899698c47d0b8e1ea9', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const imageUrl = data.data.url;
                    document.getElementById(`teamImage-${teamId}`).value = imageUrl;
                    document.getElementById(`teamImagePreview-${teamId}`).src = imageUrl;
                    showToast('Image uploaded successfully to ImgBB!');
                    updatePreviewDebounced();
                    saveStateDebounced();
                } else {
                    throw new Error('Upload to ImgBB failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showErrorModal(`Failed to upload image to ImgBB: ${error.message}`);
                updateTeamImagePreview(document.getElementById(`teamImage-${teamId}`).value, teamId);
            })
            .finally(() => {
                document.getElementById(`uploadProgress-${teamId}`).style.display = 'none';
            });
        }
        
        function removeTeamImage(teamId) {
            document.getElementById(`teamImage-${teamId}`).value = '';
            document.getElementById(`teamImagePreview-${teamId}`).src = './images/teams/ctfbox-player.png';
            document.getElementById(`teamImageFile-${teamId}`).value = '';
            updatePreviewDebounced();
            saveStateDebounced();
        }
        
        function updateTeamImagePreview(imageUrl, teamId) {
            const preview = document.getElementById(`teamImagePreview-${teamId}`);
            preview.src = imageUrl || './images/teams/ctfbox-player.png';
            updatePreviewDebounced();
            saveStateDebounced();
        }
        
        function updateTeamTitle(id, newName) {
            const titleElement = document.getElementById(`team-title-${id}`);
            if (titleElement) {
                titleElement.textContent = newName;
            }
            updatePreviewDebounced();
            saveStateDebounced();
        }
        
        function updateTeamNopStatus(id, isNop) {
            const teamCard = document.querySelector(`.team-card[data-team-id="${id}"]`);
            if (teamCard) {
                if (isNop) {
                    teamCard.classList.add('nop-team');
                } else {
                    teamCard.classList.remove('nop-team');
                }
            }
            updatePreviewDebounced();
            saveStateDebounced();
        }
        
        function updateTeamCount() {
            const teamCount = document.querySelectorAll('.team-card').length;
            document.getElementById('teamCountDisplay').textContent = teamCount;
            updatePreviewDebounced();
            saveStateDebounced();
        }
        
        function updatePreview() {
            try {
                const config = buildConfigObject();
                const jsonStr = JSON.stringify(config, null, 4);
                const coloredJson = syntaxHighlight(jsonStr);
                document.getElementById('configPreview').innerHTML = coloredJson;
            } catch (error) {
                document.getElementById('configPreview').innerHTML = `Error generating preview: ${error.message}`;
            }
        }
        
        function copyConfigToClipboard() {
            try {
                const config = buildConfigObject();
                const jsonStr = JSON.stringify(config, null, 4);
                navigator.clipboard.writeText(jsonStr).then(() => {
                    const copyBtn = document.getElementById('copyConfig');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                    }, 2000);
                    showToast('Configuration copied to clipboard!');
                });
            } catch (error) {
                console.error(error);
                showErrorModal(`Failed to copy: ${error.message}`);
            }
        }
        
        function copyCompressedConfigToClipboard() {
            try {
                const config = buildConfigObject();
                const jsonStr = JSON.stringify(config);
                
                if (typeof pako !== 'undefined') {
                    const compressed = pako.deflate(jsonStr);
                    const base64 = btoa(String.fromCharCode.apply(null, compressed));
                    navigator.clipboard.writeText(base64).then(() => {
                        const copyBtn = document.getElementById('copyCompressedConfig');
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                        }, 2000);
                        showToast('Compressed configuration copied to clipboard!');
                    });
                } else {
                    const base64 = btoa(jsonStr);
                    navigator.clipboard.writeText(base64).then(() => {
                        const copyBtn = document.getElementById('copyCompressedConfig');
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied! (Uncompressed)';
                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                        }, 2000);
                        showToast('Configuration copied in base64 format (uncompressed)');
                    });
                }
            } catch (error) {
                console.error(error);
                showErrorModal(`Failed to copy compressed config: ${error.message}`);
            }
        }
        
        function buildConfigObject() {
            const serverAddr = document.getElementById('serverAddr').value.trim();
            if (!serverAddr) {
                throw new Error('Server Address is required');
            }
            
            const config = {
                wireguard_port: parseInt(document.getElementById('wireguardPort').value),
                wireguard_profiles: parseInt(document.getElementById('wireguardProfiles').value),
                server_addr: serverAddr,
                dns: document.getElementById('dns').value,
                grace_time: parseInt(document.getElementById('graceTime').value),
                tick_time: parseInt(document.getElementById('tickTime').value),
                flag_expire_ticks: parseInt(document.getElementById('flagExpireTicks').value),
                initial_service_score: parseInt(document.getElementById('initialServiceScore').value),
                max_flags_per_request: parseInt(document.getElementById('maxFlagsPerRequest').value),
                submission_timeout: parseFloat(document.getElementById('submissionTimeout').value),
                network_limit_bandwidth: document.getElementById('networkLimitBandwidth').value,
                max_vm_cpus: document.getElementById('maxVmCpus').value,
                max_vm_mem: document.getElementById('maxVmMem').value,
                gameserver_token: document.getElementById('gameserverToken').value || generateRandomToken(),
                unsafe_privileged: document.getElementById('unsafePrivileged').checked,
                debug: document.getElementById('debugMode').checked
            };
            
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (startTime) {
                const startDate = new Date(startTime);
                config.start_time = startDate.toISOString();
            }
            
            if (endTime) {
                const endDate = new Date(endTime);
                config.end_time = endDate.toISOString();
            }
            
            if (document.getElementById('enableDiskLimit').checked) {
                config.max_disk_size = document.getElementById('maxDiskSize').value;
            }
            
            if (document.getElementById('exposeGameserver').checked) {
                config.gameserver_exposed_port = document.getElementById('gameserverExposedPort').value;
            }
            
            if (document.getElementById('enableCredentialServer').checked) {
                config.credential_server = document.getElementById('credentialServerPort').value;
            }
            
            config.teams = [];
            const numberOfTeams = parseInt(document.getElementById('numberOfTeams').value);
            const enableNopTeam = document.getElementById('enableNopTeam').checked;
            
            let startIndex = 0;
            let totalTeams = numberOfTeams;
            
            if (enableNopTeam) {
                startIndex = 1;
                totalTeams += 1;
            }
            
            for (let i = 0; i < totalTeams; i++) {
                if (i === 0 && !enableNopTeam) {
                    continue;
                }
                
                const teamNameElement = document.getElementById(`teamName-${i}`);
                if (!teamNameElement) continue;
                
                const team = {
                    id: i,
                    name: teamNameElement.value,
                    token: document.getElementById(`teamToken-${i}`).value || generateRandomToken(),
                    nop: document.getElementById(`teamNop-${i}`).checked,
                    image: document.getElementById(`teamImage-${i}`).value || ""
                };
                
                config.teams.push(team);
            }
            
            return config;
        }
        
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                        match = match.replace(/"/g, '').replace(/:$/, '');
                        return `"<span class="${cls}">${match}</span>": `;
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return `<span class="${cls}">${match}</span>`;
            });
        }
        
        function generateRandomToken() {
            const array = new Uint8Array(32);
            window.crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }
        
        function downloadJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 4);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function processImportConfig() {
            const fileInput = document.getElementById('importConfigFile');
            const textInput = document.getElementById('importConfigTextarea').value.trim();
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const config = JSON.parse(content);
                        applyImportedConfig(config);
                        saveStateDebounced(); // Save imported config to localStorage
                        
                        const importModal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                        importModal.hide();
                    } catch (error) {
                        console.error(error);
                        showErrorModal(`Error parsing JSON file: ${error.message}`);
                    }
                };
                reader.readAsText(fileInput.files[0]);
            } else if (textInput) {
                try {
                    let config;
                    
                    try {
                        config = JSON.parse(textInput);
                    } catch (jsonError) {
                        try {
                            if (typeof pako === 'undefined') {
                                throw new Error("Compression library not loaded. Cannot decompress base64 input.");
                            }
                            
                            const binaryString = atob(textInput);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            
                            const decompressed = pako.inflate(bytes, { to: 'string' });
                            config = JSON.parse(decompressed);
                        } catch (decompressError) {
                            throw new Error("Input is neither valid JSON nor compressed base64: " + decompressError.message);
                        }
                    }
                    
                    applyImportedConfig(config);
                    saveStateDebounced(); // Save imported config to localStorage
                    
                    const importModal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                    importModal.hide();
                } catch (error) {
                    console.error(error);
                    showErrorModal(`Error processing input: ${error.message}`);
                }
            } else {
                showErrorModal("Please upload a file or paste configuration text.");
            }
        }
        
        function applyImportedConfig(config) {
            try {
                resetFormToDefaults();
                
                if (config.wireguard_port) document.getElementById('wireguardPort').value = config.wireguard_port;
                if (config.wireguard_profiles) document.getElementById('wireguardProfiles').value = config.wireguard_profiles;
                if (config.server_addr) document.getElementById('serverAddr').value = config.server_addr;
                if (config.dns) document.getElementById('dns').value = config.dns;
                
                if (config.grace_time !== undefined) {
                    document.getElementById('graceTime').value = config.grace_time;
                    setGraceTimeInputs(config.grace_time);
                }
                
                if (config.tick_time) document.getElementById('tickTime').value = config.tick_time;
                
                if (config.start_time) {
                    const startDate = new Date(config.start_time);
                    document.getElementById('startTime').value = formatDateForInput(startDate);
                }
                
                if (config.end_time) {
                    const endDate = new Date(config.end_time);
                    document.getElementById('endTime').value = formatDateForInput(endDate);
                }
                
                if (config.flag_expire_ticks) document.getElementById('flagExpireTicks').value = config.flag_expire_ticks;
                if (config.initial_service_score) document.getElementById('initialServiceScore').value = config.initial_service_score;
                if (config.max_flags_per_request) document.getElementById('maxFlagsPerRequest').value = config.max_flags_per_request;
                if (config.submission_timeout) document.getElementById('submissionTimeout').value = config.submission_timeout;
                
                if (config.network_limit_bandwidth) document.getElementById('networkLimitBandwidth').value = config.network_limit_bandwidth;
                if (config.max_vm_cpus) document.getElementById('maxVmCpus').value = config.max_vm_cpus;
                if (config.max_vm_mem) document.getElementById('maxVmMem').value = config.max_vm_mem;
                
                if (config.max_disk_size) {
                    document.getElementById('enableDiskLimit').checked = true;
                    document.getElementById('diskLimitField').style.display = 'block';
                    document.getElementById('maxDiskSize').value = config.max_disk_size;
                }
                
                if (config.gameserver_token) document.getElementById('gameserverToken').value = config.gameserver_token;
                if (config.unsafe_privileged !== undefined) document.getElementById('unsafePrivileged').checked = config.unsafe_privileged;
                if (config.debug !== undefined) document.getElementById('debugMode').checked = config.debug;
                
                if (config.gameserver_exposed_port) {
                    document.getElementById('exposeGameserver').checked = true;
                    document.getElementById('gameserverPortField').style.display = 'block';
                    document.getElementById('gameserverExposedPort').value = config.gameserver_exposed_port;
                }

                if (config.credential_server) {
                    document.getElementById('enableCredentialServer').checked = true;
                    document.getElementById('credentialServerField').style.display = 'block';
                    document.getElementById('credentialServerPort').value = config.credential_server;
                }
                
                if (config.teams && Array.isArray(config.teams) && config.teams.length > 0) {
                    document.getElementById('teamsContainer').innerHTML = '';
                    
                    const hasNopTeam = config.teams.some(team => team.id === 0 || team.nop === true);
                    document.getElementById('enableNopTeam').checked = hasNopTeam;
                    
                    const regularTeams = config.teams.filter(team => team.id > 0 || !team.nop);
                    document.getElementById('numberOfTeams').value = regularTeams.length;
                    
                    config.teams.forEach(team => {
                        const teamCard = createTeamCard(team.id, team.name, team.nop);
                        teamCard.setAttribute('data-team-id', team.id);
                        document.getElementById('teamsContainer').appendChild(teamCard);
                        
                        document.getElementById(`teamName-${team.id}`).value = team.name;
                        if (team.nop !== undefined && team.id !== 0) document.getElementById(`teamNop-${team.id}`).checked = team.nop;
                        if (team.token) document.getElementById(`teamToken-${team.id}`).value = team.token;
                        if (team.image) {
                            document.getElementById(`teamImage-${team.id}`).value = team.image;
                            updateTeamImagePreview(team.image, team.id);
                        }
                        
                        updateTeamTitle(team.id, team.name);
                        updateTeamNopStatus(team.id, team.nop);
                    });
                }
                
                updateTeamCount();
                updatePreview();
                
                showToast('Configuration imported successfully!', 'success');
            } catch (error) {
                console.error("Error applying configuration:", error);
                showErrorModal(`Error applying configuration: ${error.message}`);
            }
        }
        
        function resetFormToDefaults() {
            document.getElementById('wireguardPort').value = 51000;
            document.getElementById('wireguardProfiles').value = 30;
            document.getElementById('serverAddr').value = '';
            document.getElementById('dns').value = '1.1.1.1';
            
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('graceTimeHours').value = 0;
            document.getElementById('graceTimeMinutes').value = 5;
            document.getElementById('graceTimeSeconds').value = 0;
            document.getElementById('graceTime').value = 300;
            document.getElementById('tickTime').value = 120;
            
            document.getElementById('flagExpireTicks').value = 5;
            document.getElementById('initialServiceScore').value = 5000;
            document.getElementById('maxFlagsPerRequest').value = 3000;
            document.getElementById('submissionTimeout').value = 0.03;
            
            document.getElementById('networkLimitBandwidth').value = '50mbit';
            document.getElementById('maxVmCpus').value = '1';
            document.getElementById('maxVmMem').value = '2G';
            document.getElementById('enableDiskLimit').checked = false;
            document.getElementById('diskLimitField').style.display = 'none';
            document.getElementById('maxDiskSize').value = '30G';
            
            document.getElementById('gameserverToken').value = '';
            document.getElementById('unsafePrivileged').checked = false;
            document.getElementById('exposeGameserver').checked = false;
            document.getElementById('gameserverPortField').style.display = 'none';
            document.getElementById('gameserverExposedPort').value = '127.0.0.1:8888';
            document.getElementById('debugMode').checked = false;

            document.getElementById('enableCredentialServer').checked = false;
            document.getElementById('credentialServerField').style.display = 'none';
            document.getElementById('credentialServerPort').value = '0.0.0.0:4040';
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function updateGraceTime() {
            const hours = parseInt(document.getElementById('graceTimeHours').value) || 0;
            const minutes = parseInt(document.getElementById('graceTimeMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('graceTimeSeconds').value) || 0;
            
            // Convert to total seconds
            const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
            
            document.getElementById('graceTime').value = totalSeconds;
            updatePreviewDebounced();
            saveStateDebounced();
        }
        
        function setGraceTimeInputs(totalSeconds) {
            // Convert from total seconds to h/m/s
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            document.getElementById('graceTimeHours').value = hours;
            document.getElementById('graceTimeMinutes').value = minutes;
            document.getElementById('graceTimeSeconds').value = seconds;
        }

        document.getElementById('importModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('importConfigFile').value = '';
            document.getElementById('importConfigTextarea').value = '';
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</body>
</html>